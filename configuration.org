#+STARTUP: overview

# TODO: play with https://github.com/cpitclaudel/monospacifier

* Startup
#+begin_src emacs-lisp :results none
(defvar file-name-handler-alist-old file-name-handler-alist)

(setq package-enable-at-startup nil
      file-name-handler-alist nil
      message-log-max 16384
      gc-cons-threshold 402653184
      gc-cons-percentage 0.7
      auto-window-vscroll nil)

(add-hook 'emacs-startup-hook
          `(lambda ()
             (setq file-name-handler-alist file-name-handler-alist-old
                   gc-cons-threshold 800000
                   gc-cons-percentage 0.1)
             (message "Emacs started in: %s" (emacs-init-time))
             (garbage-collect)
             (display-battery-mode)) t)
#+end_src

#+begin_src emacs-lisp :results none
(when (eq system-type 'darwin)
  (setq insert-directory-program "/opt/homebrew/bin/gls"))
#+end_src

#+begin_src emacs-lisp :results none
;; (use-package straight
;;   :custom
;;     ;; add project and flymake to the pseudo-packages variable so straight.el doesn't download a separate version than what eglot downloads.
;;     (straight-built-in-pseudo-packages '(emacs nadvice python image-mode project flymake))
;;     (straight-use-package-by-default t))
#+end_src

* Visuals
Set window transparency.
#+begin_src emacs-lisp :results none
(set-frame-parameter nil 'alpha-background 100)
(add-to-list 'default-frame-alist '(alpha-background . 100))
#+end_src

Font.
#+begin_src emacs-lisp :results none
(defun setup-4k ()
    (interactive)
    
  (set-face-attribute 'default nil :font "Roboto Mono for Powerline-15")
  (set-face-attribute 'fixed-pitch nil :font "Roboto Mono for Powerline-15")
  (set-face-attribute 'variable-pitch nil :font "Roboto Mono for Powerline-15"))

(defun setup-regular ()
  (interactive)
  
  (set-face-attribute 'default nil :font "Roboto Mono for Powerline-13")
  (set-face-attribute 'fixed-pitch nil :font "Roboto Mono for Powerline-13")
  (set-face-attribute 'variable-pitch nil :font "Roboto Mono for Powerline-13"))

(set-face-attribute 'default nil :font "Roboto Mono for Powerline-13")
(set-face-attribute 'fixed-pitch nil :font "Roboto Mono for Powerline-13")
(set-face-attribute 'variable-pitch nil :font "Roboto Mono for Powerline-13")
#+end_src
 
Hide all the bezels.
#+begin_src emacs-lisp :results none
(tool-bar-mode -1)
(toggle-scroll-bar -1)
(blink-cursor-mode -1)
(setq cursor-in-non-selected-windows nil)
#+end_src

#+begin_src emacs-lisp :results none
;; for yabai to work properly on OSX
(menu-bar-mode t)
#+end_src

#+begin_src emacs-lisp :results none
(setq-default left-margin-width 3)
(setq-default right-margin-width 3)
#+end_src

#+begin_src emacs-lisp :results none
(setq-default tab-bar-new-button-show nil)
(setq-default tab-bar-close-button-show nil)
(setq-default tab-bar-separator "")
(setq-default tab-bar-auto-width-max '(300 20))
#+end_src

Color theme.
#+begin_src emacs-lisp :results none
(add-to-list 'custom-theme-load-path "~/.emacs.d/themes")
(load-theme 'noctilux t)

;; (load-theme 'modus-operandi t)
#+end_src

#+begin_src emacs-lisp :results none
(defun toggle-cursor-visibility ()
  (interactive)
  (if (internal-show-cursor-p)
    (internal-show-cursor nil nil)
    (internal-show-cursor nil t)))
#+end_src

* Sensible settings
#+begin_src emacs-lisp :results none
;; (setenv "JAVA_HOME" "/Library/Java/JavaVirtualMachines/temurin-11.jdk/Contents/Home")
#+end_src

Disable backup and lockfiles.
#+begin_src emacs-lisp :results none
(setq make-backup-files nil)
(setq create-lockfiles nil)
#+end_src

MacOS settings
#+begin_src emacs-lisp :results none
(setq mac-option-modifier 'meta)
(setq mac-right-option-modifier nil)
#+end_src

#+begin_src emacs-lisp :results none
(setq ring-bell-function #'ignore)
#+end_src

#+begin_src emacs-lisp :results none
(setq vc-follow-symlinks t)
#+end_src

#+begin_src emacs-lisp :results none
(setq custom-file (locate-user-emacs-file "custom-vars.el"))
(load custom-file 'noerror 'nomessage)
#+end_src

#+begin_src emacs-lisp :results none
(setq use-dialog-box nil)
#+end_src

#+begin_src emacs-lisp :results none
(setq max-specpdl-size 10000)
#+end_src

#+begin_src emacs-lisp :results none
(setq global-auto-revert-non-file-buffers t)
(setq auto-revert-verbose nil)
(setq auto-revert-interval 0.2)
(global-auto-revert-mode 1)
#+end_src

Disable saving the clipboard after exiting Emacs.
#+begin_src emacs-lisp :results none
(setq x-select-enable-clipboard-manager nil)
#+end_src

Convert tabs to spaces.
#+begin_src emacs-lisp :results none
(setq tab-width 2)
(setq indent-tabs-mode nil)
#+end_src

Ask before closing Emacs.
#+begin_src emacs-lisp :results none
(setq confirm-kill-emacs 'y-or-n-p)
#+end_src

#+begin_src emacs-lisp :results none
(setq bookmark-save-flag 1)
#+end_src

#+begin_src emacs-lisp :results none
(setq require-final-newline nil)
#+end_src

Use colors in compilation buffer. defer?
#+begin_src emacs-lisp :results none
(defun colorize-compilation-buffer ()
  (require 'ansi-color)
  (ansi-color-apply-on-region compilation-filter-start (point)))
  
(add-hook 'compilation-filter-hook 'colorize-compilation-buffer)
#+end_src
  
Open buffer position
#+begin_src emacs-lisp :results none
(setq display-buffer-alist
  '(("\\*\\(compilation\\)\\*"
     (display-buffer-reuse-window)
     (side            . bottom)
     (reusable-frames . visible)
     (window-height   . 0.33))

   ("\\*\\(Flycheck errors\\)\\*"
     (display-buffer-in-side-window)
     (side            . bottom)
     (reusable-frames . visible)
     (slot            . 1)
     (window-height   . 0.33))

    ("\\*Org todo\\*"
     (display-buffer-in-side-window)
     (side            . bottom)
     (reusable-frames . visible)
     (window-height   . 0.2))

    ("\\*\\([Hh]elp\\|Messages\\|helpful.*\\|xref\\)\\*"
     (display-buffer-in-side-window)
     (side           . right)
     (window-width   . 0.5))

    ("\\*\\(eshell\\|Python\\|Synonyms List\\)\\*"
     (display-buffer-in-side-window)
     (side           . bottom)
     (window-height  . 0.4))

    ("\\*\\(Buffer List\\|Bufler\\)\\*"
     (display-buffer-same-window))

    ("\\*Async Shell Command\\*"
     (display-buffer-no-window))

    ("\\*Man .*\\*"
     (display-buffer-in-side-window)
     (side           . right)
     (window-width   . 0.5))

    ("^magit:.*"
     (display-buffer-same-window))))
#+end_src

Line wrapping.
#+begin_src emacs-lisp :results none
(setq-default truncate-lines t)
(setq truncate-lines t)
(setq truncate-partial-width-windows nil)
(setq-default fill-column 120)
#+end_src
  
Allow remembering risky variables
#+begin_src emacs-lisp :results none
(defun risky-local-variable-p (sym &optional _ignored) nil)
#+end_src

Compilation settings.
#+begin_src emacs-lisp :results none
(setq compilation-scroll-output t)
(setq compilation-always-kill t)
#+end_src

#+begin_src emacs-lisp :results none
(setq revert-without-query '(".*"))
#+end_src

* Miscellaneous 
#+begin_src emacs-lisp :results none
(setq auth-sources '("~/.authinfo"))
#+end_src

#+begin_src emacs-lisp :results none
(setq home "/home/porcupine")
(setq p/bibliography `(,(concat home "/Dropbox/org/bibliography.bib")))
#+end_src

#+begin_src emacs-lisp :results none
;; temporary fix to: https://github.com/magit/magit/issues/5011
(defun seq-keep (function sequence)
  "Apply FUNCTION to SEQUENCE and return the list of all the non-nil results."
  (delq nil (seq-map function sequence)))
#+end_src

* Use =evil-mode=
Use =evil-mode=
#+begin_src emacs-lisp :results none
(use-package evil
  :straight t
  :demand
  :init
    (setq evil-want-keybinding nil)
  :config
    (setq evil-ex-substitute-global t)
    (setq aw-keys '(?h ?j ?k ?l ?a ?s ?d ?f))

    (defmacro define-and-bind-text-object (key start-regex end-regex)
      (let ((inner-name (make-symbol "inner-name"))
            (outer-name (make-symbol "outer-name")))
        `(progn
           (evil-define-text-object ,inner-name (count &optional beg end type)
             (evil-select-paren ,start-regex ,end-regex beg end type count nil))
           (evil-define-text-object ,outer-name (count &optional beg end type)
             (evil-select-paren ,start-regex ,end-regex beg end type count t))
           (define-key evil-inner-text-objects-map ,key (quote ,inner-name))
           (define-key evil-outer-text-objects-map ,key (quote ,outer-name)))))
    
    (define-and-bind-text-object "=" "=" "=")
    (define-and-bind-text-object "~" "~" "~")
    (define-and-bind-text-object "*" "*" "*")
    (define-and-bind-text-object "_" "_" "_")
    (define-and-bind-text-object "/" "/" "/")

    (evil-define-key '(normal insert) global-map (kbd "C-n") 'evil-avy-goto-char)

    (evil-mode +1)
  :bind (:map evil-motion-state-map
        ("C-w C-U" . winner-undo)
        ("C-w C-w" . ace-window)
        ("C-w w"   . ace-window)))

(use-package evil-collection
  :after evil
  :straight t
  :config
    (evil-collection-init))
#+end_src

Use =evil-commentary=
#+begin_src emacs-lisp :results none
(use-package evil-commentary
   :after evil
   :straight t
   :config
    (evil-commentary-mode +1))
#+end_src

Use =evil-surround=
#+begin_src emacs-lisp :results none
(use-package evil-surround
   :straight t
   :after evil
   :config
     (global-evil-surround-mode +1))
#+end_src

#+begin_src emacs-lisp :results none
(use-package evil-escape
  :straight t
  :after evil
  :config
   (evil-escape-mode 1))
#+end_src

* Configure =hydra=
#+begin_src emacs-lisp :results none
(use-package hydra
 :straight t
 :defer t
 :custom 
   (head-hint nil)
   (hydra-key-format-spec "[%s]"))
#+end_src

** Dired
#+begin_src emacs-lisp :results none
(defhydra hydra-dired-bookmarks (:color blue)
  ("b" (lambda () (interactive) (dired "~/books/")))
  ("c" (lambda () (interactive) (dired "~/studies")))
  ("d" (lambda () (interactive) (dired "~/Downloads/")))
  ("D" (lambda () (interactive) (dired "~/Dropbox/")))
  ("g" (lambda () (interactive) (dired "~/Dropbox/Apps/GoodNotes 5/'/GoodNotes/")))
  ("h" (lambda () (interactive) (dired "~/")))
  ("m" (lambda () (interactive) (dired "~/work/monorepo/")))
  ("s" (lambda () (interactive) (dired "~/Dropbox/org/resources/studies/")))
  ("S" (lambda () (interactive) (dired "~/scripts/")))
  ("w" (lambda () (interactive) (dired "~/work/")))
  ("y" (lambda () (interactive) (dired "~/youtube/"))))
#+end_src

** Forge 
#+begin_src emacs-lisp :results none
(defhydra hydra-forge (:color blue)
  "
  ^
  ^Forge^     
  ^────^───────────
  _a_ Assign reviewer
  _b_ Browse
  _c_ Create PR
  _p_ Browse PR
  ^^        
  "
  ("a" #'forge-edit-topic-review-requests)
  ("b" #'forge-browse-remote)
  ("c" #'forge-create-pullreq)
  ("p" #'forge-browse-pullreq))
#+end_src
   
** Scala
#+begin_src emacs-lisp :results none
(defhydra hydra-scala-surround (:color blue)
   "
   ^
   ^Surround^     
   ^────^───────────
   _l_ List
   _o_ Option
   _i_ IO
   _f_ Future
   ^^        
   "
   ("l" #'+scala/surround-word-with-list)
   ("o" #'+scala/surround-word-with-option)
   ("t" #'+scala/surround-word-with-try)
   ("i" #'+scala/surround-word-with-io)
   ("f" #'+scala/surround-word-with-future)
   ("s" #'+scala/surround-word-with-future-successful))
 #+end_src
 
** Python
#+begin_src emacs-lisp :results none
(defhydra hydra-python-surround (:color blue)
   "
   ^
   ^Surround^     
   ^────^───────────
   _l_ List
   _o_ Optional
   ^^        
   "
   ("l" #'+python/surround-word-with-list)
   ("o" #'+python/surround-word-with-optional))
#+end_src

** GPT
#+begin_src emacs-lisp :results none
(defhydra hydra-gpt (:color blue)
   "
   ^
   ^Surround^     
   ^────^───────────
   _e_ Explain
   _d_ Define (and Translate)
   ^^        
   "
   ("e" #'gpt-explain)
   ("d" #'gpt-define))
#+end_src

* Global keybindings 
Buffer commands.
#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-x C-x") #'save-buffer)
(global-set-key (kbd "C-x C-b") #'ibuffer)
(global-set-key (kbd "C-c b n") #'next-buffer)
(global-set-key (kbd "C-c b p") #'previous-buffer)
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c a") #'+agenda/daily-agenda)
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "M-k") #'drag-stuff-up)
(global-set-key (kbd "M-j") #'drag-stuff-down)
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c w w") #'winman-switch)
(global-set-key (kbd "C-c w s") #'winman-save)
(global-set-key (kbd "C-c w r") #'winman-update)
(global-set-key (kbd "C-c w R") #'winman-rename)
(global-set-key (kbd "C-c w d") #'winman-delete)
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-x f") (lambda () (interactive) (consult-find default-directory)))
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c j j") #'org-roam-dailies-goto-today)
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c g") #'gpt-init)
(global-set-key (kbd "C-c G") #'gptel)
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c s") #'pjira-current-sprint)
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c P") #'copilot-mode)
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-<backspace>") #'my-backward-delete)

(require 'cc-engine) ;; for c-hungry-backspace - maybe can be replaced with something else

(defun my-backward-delete ()
   (interactive)
   (if (member (char-before) '(?\s ?\t))
     (c-hungry-backspace)
     (backward-kill-word 1)))
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c n b") #'ivy-bibtex)
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-x 4 j") #'dired-jump-other-window)
#+end_src

#+begin_src emacs-lisp :results none
(global-unset-key (kbd "C-SPC"))
#+end_src

#+begin_src emacs-lisp :results none
(global-unset-key (kbd "C-x C-q"))
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-M-k") #'consult-yank-from-kill-ring)
#+end_src

Evaluation commands.
#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c e d") #'eval-defun)
(global-set-key (kbd "C-c e b") #'eval-buffer)
#+end_src

Dired jump.
#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-x C-j") 'dired-jump)
#+end_src

#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c i") (lambda () (interactive) (org-capture nil "i")))
#+end_src

Disable downcase-region
#+begin_src emacs-lisp :results none
(global-unset-key (kbd "C-x C-l"))
#+end_src

Toggle line truncation.
#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-x w") 'toggle-truncate-lines)
#+end_src

Easier movements between splits.
#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-h") #'evil-window-left)
(global-set-key (kbd "C-j") #'evil-window-down)
(global-set-key (kbd "C-k") #'evil-window-up)
(global-set-key (kbd "C-l") #'evil-window-right)
#+end_src

Only window.
#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c o") #'delete-other-windows)
#+end_src

Vim-like screen jumping.
#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-u") #'evil-scroll-up)
#+end_src

Use "C-w d" to close a window.
#+begin_src emacs-lisp :results none
(define-key evil-window-map (kbd "d") #'evil-window-delete)
#+end_src

Use =zoom-window=.
#+begin_src emacs-lisp :results none
(define-key evil-window-map (kbd "o") #'zoom-window-zoom)
(define-key evil-window-map (kbd "C-o") #'zoom-window-zoom)
#+end_src

Use =org-capture=.
#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c c") #'org-capture)
#+end_src

Use =emojify-mode=
#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-c n e") #'emojify-insert-emoji)
#+end_src

Scale text.
#+begin_src emacs-lisp :results none
(global-set-key (kbd "C-+") #'text-scale-increase)
(global-set-key (kbd "C--") #'text-scale-decrease)
#+end_src
  
* Misc Functions
#+begin_src emacs-lisp :results none
(defun +core/scratch-buffer () 
   (interactive)
   (switch-to-buffer (generate-new-buffer "*scratch*"))
   (text-mode))
#+end_src
 
#+begin_src emacs-lisp :results none
(defun +core/convert-to-list ()
  (interactive)
  (evil-ex (concat "'<,'>" "s/" ".*" "/" "\"\\0\"," "/g")))
#+end_src

#+begin_src emacs-lisp :results none
  (defun +core/refresh-config ()
    (interactive)
    (org-babel-tangle-file "~/.emacs.d/configuration.org" "~/.emacs.d/configuration.el"))
 #+end_src
  
#+begin_src emacs-lisp :results none
(defun +core/summon-scratch ()
   (interactive)
   (switch-to-buffer-other-window "*scratch*")
   (text-mode))
#+end_src

#+begin_src emacs-lisp :results none
(defun +core/copy-file-path ()
  (interactive)
  (kill-new (buffer-file-name)))
#+end_src
 
#+begin_src emacs-lisp :results none
(defun +core/reload-theme ()
   (interactive)
   (let ((theme (-first-item custom-enabled-themes)))
      (load-theme theme t)))
#+end_src
 
#+begin_src emacs-lisp :results none
(defvar +core/dark-theme 'noctilux)
(defvar +core/light-theme 'modus-operandi)

(setq modus-themes-fringes nil)

(setq org-format-latex-options (plist-put org-format-latex-options :background "#282a36"))

(defun +core/load-theme (theme)
  (mapcar #'disable-theme custom-enabled-themes)
  (load-theme theme t))

(defun +core/redraw-dired-buffers ()
  (dolist (buffer (buffer-list))
    (with-current-buffer buffer
      (if (equal major-mode #'dired-mode)
	  (revert-buffer)))))

(defun +core/toggle-darkmode ()
  (interactive)

  (if (equal (car custom-enabled-themes) +core/dark-theme)
      (progn
	(setq org-todo-keyword-faces '(("TODO"  .   (:foreground "red" :background "white"))))
	(setq org-modern-todo-faces org-todo-keyword-faces)
	(+core/load-theme +core/light-theme)
	(setq org-format-latex-options (plist-put org-format-latex-options :background "white")))
    (progn
      (+core/load-theme +core/dark-theme)
      (setq org-format-latex-options (plist-put org-format-latex-options :background "#282a36"))))

  (+core/redraw-dired-buffers))
#+end_src

Based on the excellent [[https://protesilaos.com/dotemacs/#h:0077f7e0-409f-4645-a040-018ee9b5b2f2][LINK]]
#+begin_src emacs-lisp :results none
(defun +core/to-floating-frame()
  (interactive)
  (delete-window)
  (make-frame '((name . "floating")
                (window-system . x)
                (minibuffer . nil))))

 (defun +core/to-regular-bottom-window()
    (interactive)
    (+core/to-regular-window `bottom))

(defun +core/to-regular-right-window()
   (interactive)
   (+core/to-regular-window `right))

(defun +core/to-regular-window(position)
  (let ((buffer (current-buffer)))
    (with-current-buffer buffer
      (delete-window)
      (pcase position
        (`bottom (display-buffer-at-bottom buffer nil))
        (`right (display-buffer-in-direction buffer '((direction . right))))))))
#+end_src
  
#+begin_src emacs-lisp :results none
(defun +core/surround-word-with (left right)
   (backward-to-word 1)
   (forward-to-word 1)
   (kill-word 1)
   (insert left)
   (yank)
   (insert right))
#+end_src

* Configure =exec-path-from-shell=

#+begin_src emacs-lisp :results none
(use-package exec-path-from-shell
  :straight t
  :init
    (exec-path-from-shell-initialize))

;; (defun set-exec-path-from-shell-PATH ()
;;   (let ((path-from-shell (replace-regexp-in-string
;;                           "[ \t\n]*$"
;;                           ""
;;                           (shell-command-to-string "echo $PATH"))))
;;     (setenv "PATH" path-from-shell)
;;     (setq exec-path (split-string path-from-shell path-separator))))
;; 
;; (when window-system (set-exec-path-from-shell-PATH))
;; 
;; (let ((explicit-shell-file-name "/usr/bin/bash"))
;;   (shell-command-to-string "echo $PATH"))
#+end_src

* Configure =which-key=
#+begin_src emacs-lisp :results none
(use-package which-key
  :straight t
  :defer t
  :init (which-key-mode))
#+end_src
 
* Configure =avy= / =evil-easymotion= / =evil-snipe=
#+begin_src emacs-lisp :results none
(use-package avy 
  :straight t
  :defer t)
  
(use-package evil-easymotion
  :straight t
  :defer t)
#+end_src

#+begin_src emacs-lisp :results none
(define-key evil-motion-state-map (kbd "g s k") #'evilem-motion-previous-line)
(define-key evil-motion-state-map (kbd "g s j") #'evilem-motion-next-line)
(define-key evil-motion-state-map (kbd "g s f") #'evil-avy-goto-char)
(define-key evil-motion-state-map (kbd "g s s") #'evil-avy-goto-char-2)
#+end_src

* Configure =tabspaces=
#+begin_src emacs-lisp :results none
(use-package tabspaces
  :straight (:type git :host github :repo "mclear-tools/tabspaces")
  ;; :hook
  ;;   (after-init . tabspaces-mode) 
  :commands
    (tabspaces-switch-or-create-workspace
     tabspaces-open-or-create-project-and-workspace)
  :custom
    (tabspaces-use-filtered-buffers-as-default t)
    (tabspaces-default-tab "Default")
    (tabspaces-remove-to-default t)
    (tabspaces-include-buffers '("*scratch*"))
    (tabspaces-initialize-project-with-todo t)
    ;; sessions
    ;; (tabspaces-session t)
    ;; (tabspaces-session-auto-restore t)

  :config
     (define-key evil-normal-state-map (kbd "gt") #'tab-next)
     (define-key evil-normal-state-map (kbd "gT") #'tab-previous))
#+end_src

* Configure =recentf=
#+begin_src emacs-lisp :results none
(use-package recentf
  :straight nil
  :config
    (setq recentf-max-saved-items 500)
    (add-to-list 'recentf-keep 'file-remote-p)
    (add-hook 'find-file-hook 'recentf-save-list)
    (recentf-mode +1))
#+end_src

* Configure =flycheck=
#+begin_src emacs-lisp :results none
(use-package flycheck
  :defer t
  :straight t
  ;; :init (global-flycheck-mode)
  :config 
    (evil-define-key '(normal) flycheck-mode-map (kbd "] e") 'flycheck-next-error)
    (evil-define-key '(normal) flycheck-mode-map (kbd "[ e") 'flycheck-previous-error)

    (defvar arrow (vector 
      #b00100000
      #b00110000
      #b00111000
      #b00111100
      #b00111110
      #b00111100
      #b00111000
      #b00110000
      #b00100000))

    (defvar line (vector 
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000
       #b00100000))

    (define-fringe-bitmap 'flycheck-fringe-bitmap-ball arrow)
    (define-fringe-bitmap 'flycheck-fringe-bitmap-continuation line)
    ;; flycheck-fringe-bitmap-continuation (?)

    ;; TODO: bookmarks
    (define-fringe-bitmap 'bookmark-fringe-mark arrow)

    (flycheck-define-error-level 'error
      :severity 100
      :compilation-level 2
      :overlay-category 'flycheck-error-overlay
      :fringe-bitmap 'flycheck-fringe-bitmap-ball
      :fringe-face 'flycheck-fringe-error
      :error-list-face 'flycheck-error-list-error)

    (flycheck-define-error-level 'warning
      :severity 50
      :compilation-level 1
      :overlay-category 'flycheck-warning-overlay
      :fringe-bitmap 'flycheck-fringe-bitmap-ball
      :fringe-face 'flycheck-fringe-warning
      :error-list-face 'flycheck-error-list-warning)

    (setq-default flycheck-disabled-checkers '(emacs-lisp-checkdoc proselint)))
#+end_src

#+begin_src emacs-lisp :results none
(use-package flycheck-projectile
  :straight t 
  :defer t)
#+end_src

* Configure =flymake=

#+begin_src emacs-lisp :results none
(use-package flymake
  :straight nil
  :config
    (evil-collection-define-key 'normal 'flymake-mode-map
      (kbd "] e") 'flymake-goto-next-error
      (kbd "[ e") 'flymake-goto-prev-error))
#+end_src

* Configure =org=
** Core
#+begin_src emacs-lisp :results none
  (use-package org
    :straight t
    :defer t
    :delight
    :custom
    (org-ellipsis " ▾")
    
    :config 
    (require 'org-tempo)
    
    (setq org-hide-emphasis-markers t)
    (setq org-pretty-entities nil)
    (setq korg-list-allow-alphabetical t)
    (setq org-fontify-done-headline t)
    (setq org-use-fast-todo-selection 'expert)
    (setq org-image-actual-width nil)
    (setq org-src-window-setup 'split-window-below)
    (setq org-odt-preferred-output-format "docx")
    (setq org-confirm-babel-evaluate nil)
    (setq org-tags-column 0)
    (setq org-insert-heading-respect-content t)
    (setq org-auto-align-tags nil)
    (setq org-capture-bookmark nil)
    (setq org-export-with-sub-superscripts nil)
    (setq org-indirect-buffer-display 'current-window)

    (setq org-src-fontify-natively t)
    (setq org-src-tab-acts-natively t)
    (setq org-src-preserve-indentation t)

    (setq org-html-validation-link nil)

    (setq org-fontify-quote-and-verse-blocks t)

    ;; org-cite configuration

    (setq org-cite-global-bibliography p/bibliography)

    ;; ignore some unwanted warnings
    ;; (setq warning-suppress-types (append warning-suppress-types '((org-element-cache))))
    
    ;; (setq warning-suppress-types (append warning-suppress-types '((defvaralias))))

    (setq org-refile-targets
  	'(("/home/porcupine/Dropbox/org/todo/work.org" :maxlevel . 1)
  	  ("/home/porcupine/Dropbox/org/todo/private.org" :maxlevel . 1)))

    ;; babel configuration
    (org-babel-do-load-languages 'org-babel-load-languages
  			       '((shell . t)
  				 (emacs-lisp . t)
  				 (python . t)
  				 (plantuml . t)
  				 (scheme . t) 
  				 (js . t)
  				 (sql . t)
  				 (R . t)
  				 ;; (jupyter . t)
  				 ;; (ammonite . t)
  				 ;; (http . t)
  				 ;; (mongo . t)
  				 (haskell . t)))

    (setq org-plantuml-jar-path
          (expand-file-name "~/tools/plantuml.jar"))

    (push '("\\.excalidraw.svg\\'" . "echo '%s' | sed 's/.svg//' | xargs open") org-file-apps)


    (setq org-startup-with-inline-images t)

    (add-hook 'org-babel-after-execute-hook 'org-redisplay-inline-images)

    ;; LaTeX options
    (defun +latex-rescale ()
      (interactive)
      (org-latex-preview '(64))
      (plist-put (plist-put org-format-latex-options :background "white")
                 :scale (if (= (x-display-pixel-width) 1920) 1.0 2.5))
      (org-latex-preview '(16)))

    (setq org-format-latex-options 
  	(plist-put (plist-put org-format-latex-options :background "white") :scale 1.0))

    (setq org-latex-packages-alist nil)

    ;; open files in the same window
    (setf (alist-get 'file org-link-frame-setup) 'find-file)

    (setq org-todo-keywords
  	'((sequence "IDEA(i) REPEAT(r)" "TODO(t)" "NEXT(n)" "PROJECT(p)" "REVIEW(R)" "DEPLOY(E)" "STRT(s)" "SOMEDAY(S)" "WAIT(w)" "|" "DONE(d!)" "KILL(k)")
  	  (sequence "[ ](T)" "[-](S)" "[?](W)" "|" "[X](D)")))

    (evil-collection-define-key 'normal 'org-mode-map
      "gr" #'org-mode-restart
      (kbd "C-k") 'evil-window-up
      (kbd "C-j") 'evil-window-down)

    (add-to-list 'org-emphasis-alist '("`" bold :foreground "Orange"))


    (setq org-default-notes-file (concat org-directory "~/Dropbox/org/todo/notes.org"))

    (setq org-capture-templates
          '(("p" "Private" entry (file+headline "~/Dropbox/org/todo/private.org" "Private") "* TODO %?\n\n" :prepend t)
            ("s" "Studies" entry (file+headline "~/Dropbox/org/todo/studies.org" "Studies") "* TODO %?\n\n" :prepend t)
            ("w" "Work" entry (file+headline "~/Dropbox/org/todo/work.org" "Work") "* TODO %?\n\n" :prepend t)))

    (add-hook 'org-mode (lambda ()
      (setq left-margin-width 3)
      (setq right-margin-width 3)))

    (add-hook 'org-mode-hook
  	    (lambda () (progn (push '("->" . "→") prettify-symbols-alist)
  			      (push '("!=" . "≠") prettify-symbols-alist)
  			      (push '("<-" . "←") prettify-symbols-alist)
  			      (push '("<->" . "←→") prettify-symbols-alist)
  			      (push '("---" . "⎯") prettify-symbols-alist)
  			      (push '("\\\\" . "▾") prettify-symbols-alist)

  			      (prettify-symbols-mode 1))))

    (defun org-archive-save-buffer ()
      (let ((afile (car (org-all-archive-files))))
        (if (file-exists-p afile)
            (let ((buffer (find-file-noselect afile)))
              (with-current-buffer buffer
                (save-buffer)))
          (message "Ooops ... (%s) does not exist." afile))))
    
    (defun org-narrow-to-subtree-new-window ()
      (interactive)
      (org-back-to-heading)
      (let ((buf (current-buffer))
            (p (point)))
        ;; Clone the current buffer and switch to it in a new window
        (switch-to-buffer-other-window (make-indirect-buffer buf (generate-new-buffer-name "*Org Subtree*") t))
        ;; Go to the same point as in the original buffer
        (goto-char p)
        (org-narrow-to-subtree)))

    (defun paste-formatted ()
      (interactive)

      (if current-prefix-arg
         (let ((content (current-kill 0)))
            (insert (s-replace "- " "" (s-trim content)))
            (org-fill-paragraph))
         (evil-paste-after 1)))
    
    (defun copy-org-block-content ()
      (interactive)
      (save-excursion
        (let* ((element (org-element-at-point))
               (type (org-element-type element)))
          (when (or (eq type 'bsrc-block) (eq type 'quote-block))
            (let ((block-body (org-element-property :value element)))
              (if block-body
                  (progn
                    (kill-new block-body)
                    (message "Block content copied!"))
                (message "Empty block or error extracting content!")))))))

    (add-hook 'org-archive-hook 'org-archive-save-buffer)

    (add-hook 'after-init-hook
  	    (lambda ()
  	      (require 'org-indent)  
  	      (set-face-attribute 'org-indent nil
  				  :inherit '(org-hide fixed-pitch))))
    :bind
    (:map evil-normal-state-map
          ("C-c h" . org-toggle-heading)
          ("C-k" . evil-window-up)
          ("C-j" . evil-window-down)
          ("p" . paste-formatted)
  	:map org-mode-map 
          ("C-c h" . org-toggle-heading)
          ("C-c s" . org-narrow-to-subtree-new-window)
          ("C-x n S" . org-tree-to-indirect-buffer))
    :hook (org-mode . org-indent-mode)
    (org-mode . variable-pitch-mode)
    (org-mode . auto-fill-mode))
#+end_src

#+begin_src emacs-lisp :results none
(use-package org-contrib
  :after org
  :straight t)
#+end_src

#+begin_src emacs-lisp :results none
(use-package org-download
  :straight t
  :hook (org-mode . org-download-enable)
  :config
    (setq org-download-image-dir "./images"))
#+end_src

#+begin_src emacs-lisp :results none
(use-package org-utf-to-xetex
  :disabled
  :straight (org-utf-to-xetex :type git :host github :repo "grettke/org-utf-to-xetex" :branch "master")
  :commands (org-utf-to-xetex-prettify)
  :hook (org-mode . org-utf-to-xetex-prettify))
#+end_src

#+begin_src emacs-lisp :results none
(use-package org-modern
  :straight t
  :after org
  :config
    (setq org-modern-table nil)
    (setq org-modern-footnote nil)
    (global-org-modern-mode))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org/open-at-point-other-window ()
  (interactive)

  (let ((org-link-frame-setup '((vm . vm-visit-folder-other-frame)
                                (vm-imap . vm-visit-imap-folder-other-frame)
                                (file . find-file-other-window)
                                (wl . wl-other-frame))))

    (org-open-at-point)))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org/highlight-list ()
  (interactive)
  (evil-ex (concat "'<,'>" "s/" "^\\([-+*]\\) \\(.*\\)" "/" "\\1 =\\2=" "/g")))
#+end_src

#+begin_src emacs-lisp :results none
(defun is-grammatically-correct (start end)
  (interactive "r") 
  (let ((text (buffer-substring start end)))
    (kill-new text)
    (gpt-init
     (s-concat
      "Is this text grammatically correct?"
      "\n\n"
      text))))
#+end_src

** Org Agenda
#+begin_src emacs-lisp :results none
(use-package evil-org
  :straight t
  :after org
  :init
    (evil-define-text-object evil-inner-org-block (count &optional beg end type)
      "Select inner org block content."
      :extend-selection t
      (let* ((element (org-element-at-point))
             (type (org-element-type element)))
        (when (or (eq type 'src-block) (eq type 'quote-block))
          (let ((pos (save-excursion
                       (search-backward "#+begin" nil t)
                       (forward-line)
                       (point)))
                (end (save-excursion
                       (search-forward "#+end" nil t)
                       (forward-line -1)
                       (end-of-line)
                       (point))))
            (when (and pos end)
              (evil-range pos end))))))
    
    (define-key evil-inner-text-objects-map "b" 'evil-inner-org-block)
  :config
  
    (add-hook 'org-mode-hook 'evil-org-mode)
    (add-hook 'evil-org-mode-hook 'general-define-org-keys)
    (add-hook 'org-trigger-hook 'save-buffer)
    
    (require 'evil-org-agenda)
    (evil-org-agenda-set-keys))
#+end_src

#+begin_src emacs-lisp :results none
(defun general-define-org-keys ()
  (general-define-key 
      :states '(normal insert motion)
      :keymaps '(evil-org-mode-map org-mode-map)
      "C-<return>" '+org/c-ret-dwim
      "C-S-<return>" '+org/c-s-ret-dwim
      "C-M-<return>" '+org/c-m-ret-dwim
      "C-c f o" 'flash-create-note
      "C-c f l" 'flash-select-note)

  (general-define-key 
      :states '(normal)
      :keymaps '(evil-org-mode-map org-mode-map)
      "<return>" '+org/ret-dwim))
#+end_src

#+begin_src emacs-lisp :results none
(use-package pagenda
  :load-path "~/.emacs.d/packages/pagenda/"
  :commands (pagenda-mode +agenda/daily-agenda +agenda/weekly-agenda)
  :defer t)
#+end_src

#+begin_src emacs-lisp :results none
  (use-package org-super-agenda
    :straight t
    :defer t
    :hook ((org-agenda-mode . org-super-agenda-mode)
           (org-agenda-mode . pagenda-mode))
    :bind 
     (:map org-agenda-keymap (("h" . evil-backward-char) ("k" . evil-previous-line) ("l" . evil-forward-char) ("j" . evil-next-line))
      :map org-agenda-mode-map (("h" . evil-backward-char) ("k" . evil-previous-line) ("l" . evil-forward-char) ("j" . evil-next-line))
      :map org-super-agenda-header-map (("h" . evil-backward-char) ("k" . evil-previous-line) ("l" . evil-forward-char) ("j" . evil-next-line)))
    :config
      (require 'org-expiry)
  
      (setq org-expiry-inactive-timestamps t)
    
      (setq org-agenda-files '(
         "~/Dropbox/org/todo/work.org"
         "~/Dropbox/org/todo/studies.org"
         "~/Dropbox/org/todo/private.org")))
#+end_src

#+begin_src emacs-lisp :results none
(use-package org-ql
  :straight (:type git :host github :repo "alphapapa/org-ql")
  :defer t)
#+end_src

** Academic
#+begin_src emacs-lisp :results none
(use-package org-ref 
  :straight t
  :defer t
  :after org
  :config 
  (setq org-ref-default-bibliography '("~/Dropbox/org/bibliography.bib"))
  (setq org-ref-bibliography-notes "~/Dropbox/papers/notes.org")
  (setq org-ref-pdf-directory "~/Dropbox/papers/pdfs")

  (defun +org-ref/org-ref-open-associated-pdf ()
    (interactive)
    (let* ((key (string-remove-prefix "cite:" (+org/property-value "roam_key")))
	   (pdf-file (car (bibtex-completion-find-pdf key))))
      (if (and pdf-file (file-exists-p pdf-file))
	  (find-file-other-window pdf-file)
	(message "No PDF found for %s" key))))

  (defun +org-ref/org-ref-open-pdf-at-point ()
    (interactive)
    (let* ((results (org-ref-get-bibtex-key-and-file))
	   (key (car results))
	   (pdf-file (car (bibtex-completion-find-pdf key))))
      (if (file-exists-p pdf-file)
	  (org-open-file pdf-file)
	(message "No PDF found for %s" key))))

(setq org-ref-open-pdf-function '+org-ref/org-ref-open-pdf-at-point))
#+end_src
 
#+begin_src emacs-lisp :results none :tangle no
(use-package academic-phrases
  :straight t
  :defer t)
#+end_src

** Org journal
#+begin_src emacs-lisp :results none :tangle no
(use-package org-journal
  :disbled
  :straight t
  :defer t
  :init
    (setq org-journal-prefix-key "C-c j")
  :config
    (setq org-journal-dir "~/Dropbox/org/journal/"
          org-journal-date-format "%A, %d %B %Y"))
#+end_src

** Org Babel
#+begin_src emacs-lisp :results none
(use-package ob-async
  :after org
  :straight t)
#+end_src

#+begin_src emacs-lisp :results none
(use-package ob-mongo
  :straight t
  :defer t
  :custom
    (ob-mongo:default-mongo-executable "mongosh"))
#+end_src

#+begin_src emacs-lisp :results none
(use-package ob-ipython
  :straight t
  :defer t)
#+end_src

#+begin_src emacs-lisp :results none
(use-package ob-http
 :straight t
 ;; :defer t
 :config
   (add-to-list 'org-babel-load-languages '(http . t))
   (org-babel-do-load-languages 'org-babel-load-languages org-babel-load-languages))
#+end_src

#+begin_src emacs-lisp :results none
(use-package ob-ammonite
  :straight t
  :defer t)
#+end_src

#+begin_src emacs-lisp :results none 
(use-package jupyter
 :defer t
 :straight t
 ;; :commands (jupyter-org-insert-src-block jupyter-org-kill-block-and-results)
 :config
  (add-to-list 'org-babel-load-languages '(jupyter . t))
  (org-babel-do-load-languages 'org-babel-load-languages org-babel-load-languages))
#+end_src

** Functions
#+begin_src emacs-lisp :results none
(defun +org/ret-dwim ()
  (interactive)
  (let* ((context (org-element-context))
         (type (org-element-type context)))

    (pcase type
      (`headline
       (let ((todo-keyword (org-element-property :todo-keyword context)))
	 (pcase todo-keyword
	   (`"[ ]" (org-todo "[-]"))
	   (`"[-]" (org-todo "[X]"))
	   (`nil (message "+org/ret-dwim - ignore"))
           (default (org-todo)))))
      (`item
       (org-toggle-checkbox))
      (`plain-list
       (org-toggle-checkbox))
      (`paragraph
       (save-excursion
	 (beginning-of-line)
	 (forward-char)

	 (let* ((context (org-element-context))
	        (type (org-element-type context)))

	   (pcase type
	     (`item (org-toggle-checkbox))))))
      (`link
       (org-open-at-point)))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org/insert-item-next-line ()
  (move-end-of-line nil)
  (org-insert-item))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org/insert-item-prev-line ()
  (move-beginning-of-line nil)
  (org-insert-item))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org/c-ret-dwim ()
  (interactive)
  (let* ((context (org-element-context))
         (type (org-element-type context)))
    
    (pcase type
      (`item (+org/insert-item-next-line))

      (`plain-list (+org/insert-item-next-line))
      (`latex-fragment (org-latex-preview))
      (`paragraph
       (if (org-in-item-p) 
         (+org/insert-item-next-line)
         (org-insert-heading-respect-content)))
      (_ (org-insert-heading-respect-content)))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org/s-ret-dwim ()
  (interactive)
  (let* ((context (org-element-context))
         (type (org-element-type context)))
    
    (pcase type
      (_ (+org/open-at-point-other-window)))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org/c-s-ret-dwim ()
  (interactive)
  (let* ((context (org-element-context))
         (type (org-element-type context)))

    (pcase type
      (`item (+org/insert-item-prev-line))
      (`plain-list (+org/insert-item-prev-line))
      (`paragraph
       (if (org-in-item-p) 
         (+org/insert-item-prev-line)
         (+org/insert-heading-before)))
      (_ (+org/insert-heading-before)))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org/c-m-ret-dwim ()
  (interactive)
  (let* ((context (org-element-context))
         (type (org-element-type context)))


    (+org/insert-subheading-respecting-content-below)))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org/insert-subheading-respecting-content-below ()
  (interactive)
  (org-insert-heading-respect-content)
  (org-do-demote))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org/insert-heading-before ()
  (interactive)
  (org-backward-heading-same-level 0)
  (move-beginning-of-line nil)
  (org-insert-heading))
#+end_src

Save image and insert it's link at point.
#+begin_src emacs-lisp :results none
(defun +org/save-image-insert-link (url)
  (interactive "sURL: ")
  (let* ((now (floor (* 1000 (float-time))))
         (path (concat "~/Dropbox/img/" (number-to-string now) ".png")))
    (url-copy-file url path)
    (insert (concat "#+ATTR_ORG: :width 350\n" "[[" path "]]"))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org/property-value (property)
  (car (mapcar
      (lambda (prop) (org-element-property :value prop))
      (org-element-map
          (org-element-parse-buffer)
          'keyword
          (lambda (el) (when (string-match property (org-element-property :key el)) el))))))
#+end_src

** ox-slack
#+begin_src emacs-lisp :results none
(use-package ox-slack
  :defer t
  :straight t)
#+end_src

* Configure =org-excalidraw=

#+begin_src emacs-lisp :results none
(use-package org-excalidraw
  :straight (:type git :host github :repo "wdavew/org-excalidraw")
  :config
    (setq org-excalidraw-directory "~/Dropbox/org/excalidraw")
    ;; (setq org-link-abbrev-alist '("excalidraw" . "file"))
    (org-excalidraw-initialize))

    ;; (defun my/org-excalidraw-create-drawing-advice (orig-fun &rest args)
    ;;   (cl-letf (((symbol-function 'format)
    ;;              (lambda (fmt &rest args)
    ;;                (if (string-equal fmt "[[excalidraw:%s.svg]]")
    ;;                    (apply 'format "[[file:%s.svg]]" args)
    ;;                  (apply 'format fmt args)))))
    ;;     (apply orig-fun args)))
    
    ;;(advice-remove 'org-excalidraw-create-drawing :around
    ;;#'my/org-excalidraw-create-drawing-advice))
#+end_src

* Configure =citar=
#+begin_src emacs-lisp :results none
;; (use-package citar
;;   :straight t
;;   :custom
;;     (citar-notes-paths '("~/Dropbox/org-roam"))
;;     (org-cite-insert-processor 'citar)
;;     (org-cite-follow-processor 'citar)
;;     (org-cite-activate-processor 'citar)
;;     (citar-bibliography org-cite-global-bibliography)
;;     (citar-indicators (list citar-indicator-files citar-indicator-notes-icons)))

;; (use-package citar-embark
;;   :after citar embark
;;   :straight t
;;   :config
;;     (citar-embark-mode))

;; ;; https://github.com/emacs-citar/citar-org-roam
;; (use-package citar-org-roam
;;   :straight t
;;   :custom
;;     (citar-org-roam-note-title-template "${title} (${year}) | ${author}")
;;   :after (citar org-roam)
;;   :config (citar-org-roam-mode))
  #+end_src

* Configure =org-roam= 
#+begin_src emacs-lisp :results none
(use-package org-roam
  :straight t
  :defer t
  :commands org-roam-node-find
  ;; :hook (org-mode . org-roam-setup)
  :bind (:map global-map
              (("C-c n f" . (lambda () (interactive) (org-roam-node-find nil nil nil 'org-roam-node-read-sort-by-file-atime)))
               ("C-c n F" . +org-roam/find-file-by-title)
	       ("C-c n k" . (lambda () (interactive) (consult-ripgrep  org-roam-directory)))
               ("C-c n p" . citar-open)
               ("C-c n d n" . org-roam-dailies-capture-today)
               ("C-c n d d" . org-roam-dailies-goto-today))
              :map org-roam-node-map
              (("C-c n l" . +org-roam/goto-linked-file)
               ("C-c n L" . org-roam)
               ("C-c n F" . +org-roam/find-file-by-title)
               ("C-c n C" . org-roam-db-sync)
               ("C-c n g" . org-roam-buffer-display-dedicated)
               ("C-c n w" . writer)
               ("C-c n p" . +org-ref/org-ref-open-associated-pdf))
              :map org-mode-map
              (("C-c C-b" . org-cycle-list-bullet)
               ("C-c n l" . +org-roam/goto-linked-file)
               ("C-c n i" . org-roam-node-insert)))
  :init
    (setq org-roam-v2-ack t)
    (setq org-roam-node-default-sort 'file-atime)
    (setq org-roam-directory "~/Dropbox/org-roam")
    (setq org-roam-dailies-directory "journal/")
  :config  
    (setq org-roam-node-display-template
      (concat "${title:*} " (propertize "${tags:10}" 'face 'org-tag)))
  
    (setq org-roam-dailies-capture-templates
  	'(("d" "default" entry "* %<%I:%M %p>: %?"
             :if-new (file+head "%<%Y-%m-%d>.org" "#+title: Journal: %<%Y-%m-%d>\n"))))
  
    (setq org-roam-capture-templates '(
            			     ("d" "default" plain 
            			      "%?"
                                        :if-new
                                        (file+head "%(format-time-string \"%Y-%m-%d--%H-%M-%SZ--${slug}.org\" (current-time) t)"
  						 "#+title: ${title}\n#+filetags: \n#+startup: overview\n")
            			      :unnarrowed t)
                                   ("c" "class" plain 
            			      "%?"
                                        :if-new
                                        (file+head "%(format-time-string \"%Y-%m-%d--%H-%M-%SZ--${slug}.org\" (current-time) t)"
  						 "#+title: ${title}\n#+filetags: classes\n#+startup: overview\n")
            			      :unnarrowed t)
                                   ("m" "masters" plain 
            			      "%?"
                                        :if-new
                                        (file+head "%(format-time-string \"%Y-%m-%d--%H-%M-%SZ--${slug}.org\" (current-time) t)"
  						 "#+title: ${title}\n#+filetags: masters\n#+startup: overview\n")
            			      :unnarrowed t)
                                   ("z" "zowie" plain 
            			      "%?"
                                        :if-new
                                        (file+head "%(format-time-string \"%Y-%m-%d--%H-%M-%SZ--${slug}.org\" (current-time) t)"
  						 "#+title: ${title}\n#+filetags: zowie\n#+startup: overview\n")
            			      :unnarrowed t)))

   (org-roam-db-autosync-mode))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org-roam/find-file-by-title ()
  (interactive)
  (org-roam-node-find nil (+org/property-value "TITLE")))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org-roam/find-file-next ()
  (interactive)

  (let ((title (+org/property-value "TITLE")))
    (when (string-match ".*\\([0-9]+\\)" title)
      (print (match-string 1)))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org-roam/goto-linked-file ()
  (interactive)

  (let* ((titles (-map (lambda (link) (org-roam-node-title (org-roam-backlink-source-node link)))
                       (org-roam-backlinks-get (org-roam-node-at-point 'assert))))
         (title (completing-read " " titles))
         (file (org-roam-node-file (org-roam-node-from-title-or-alias title))))
    (find-file file)))
#+end_src

#+begin_src emacs-lisp :results none
(defun +org-roam/scoped-search ()
  (interactive)

  (let* ((current (org-roam-node-at-point 'assert)))
     (print current)
     (print (org-roam-reflinks-get current))))
#+end_src

#+begin_src emacs-lisp :results none :tangle no
(use-package org-roam-ui
  :straight t
  :defer t)
#+end_src

#+begin_src emacs-lisp :results none :tangle no
(defvar orb-title-format "${author-or-editor-abbrev} (${date}).  ${title}.")

(use-package org-roam-bibtex
  :disabled
  :straight t
  :defer t
  :custom
    (orb-autokey-format "%a%y")
    (orb-templates
     `(("r" "ref" plain
        (function org-roam-capture--get-point)
        ""
        :file-name "refs/${citekey}"
        :head ,(s-join "\n"
                       (list
                        (concat "#+title: "
                                orb-title-format)
                        "#+roam_key: ${ref}"
                        "#+created: %U"))
        :unnarrowed t))))
#+end_src

#+begin_src emacs-lisp
(defun +org/insert-roam-link ()
    "Inserts an Org-roam link."
    (interactive)
    (insert "[[roam:]]")
    (backward-char 2))
#+end_src

#+begin_src emacs-lisp :results none
(defun +bibtex/format-citations-apa7 (keys)
  (bibtex-completion-apa-format-reference (car keys)))
#+end_src

* Configure =code-cells=

#+begin_src emacs-lisp :results none
(use-package code-cells
  :straight t
  :defer t
  :bind (:map code-cells-mode-map
	 ("C-c C-c" . #'code-cells-eval))
  :init
    (add-hook 'python-mode-hook 'code-cells-mode-maybe))
#+end_src

* Configure =flyspell=
#+begin_src emacs-lisp :results none 
;; (use-package flyspell
;;   :straight t
;;   :defer t
;;   :config
;;     (setq ispell-program-name "hunspell")
;;     (setq ispell-dictionary "english,polish")
;;     (ispell-set-spellchecker-params)
;;     (ispell-hunspell-add-multi-dic "english,polish")

;;   :bind
;;      (:map flyspell-mode-map
;;         ("C-," . nil)
        ;; ("C-c $" . nil)))
#+end_src

* Configure =Wucuo=
#+begin_src emacs-lisp :results none
(use-package wucuo
  :straight t
  :defer t)
#+end_src

* Configure =yasnippet=
#+begin_src emacs-lisp :results none
(use-package yasnippet
  :straight t
  :defer t
  :hook ((scala-mode . yas-global-mode)
         (org-mode . yas-global-mode)
         (flash-mode . yas-global-mode)))
#+end_src

#+begin_src emacs-lisp :results none
(defun yas/proto-messages ()
  (interactive)

  (let ((content (buffer-substring-no-properties (point-min) (point-max)))
  	(matches nil))
  
      (setq pos 0)
      (while (string-match "message \\(\\w+\\)" content pos)
        (push (match-string 1 content) matches)
        (setq pos (match-end 0)))
      matches))
#+end_src

* Configure =projectile=
#+begin_src emacs-lisp :results none
(use-package projectile 
  :straight t
  :defer t
  :hook (prog-mode . projectile-global-mode)
  :config
    (projectile-global-mode)
    (setq projectile-project-search-path '("~/work/monorepo"))
    (setq projectile-track-known-projects-automatically nil)
    (setq projectile-auto-discover nil)
    (setq projectile-enable-caching t)

    (setq projectile-project-root-functions #'(projectile-root-top-down))

    ;; (setq projectile-project-root-files-functions #'(projectile-root-top-down
    ;;                                                  projectile-root-top-down-recurring
    ;;                                                  projectile-root-bottom-up
    ;;                                                  projectile-root-local))
    (setq projectile-project-root-files-bottom-up '("build.sbt" ".git" "requirements.txt" "mypy.ini" "pyproject.toml"))

    (projectile-register-project-type 'scala '("build.sbt")))
#+end_src
 
#+begin_src emacs-lisp :results none
(defun +projectile/search-word-under-cursor ()
  (interactive)
  (consult-ripgrep (projectile-project-root) (current-word)))
#+end_src

#+begin_src emacs-lisp :results none
(defun +projectile/search-todos ()
  (interactive)
  (consult-ripgrep (projectile-project-root) "todo:"))
#+end_src

#+begin_src emacs-lisp :results none
(defun +projectile/compile (command)
   (interactive)
   (let ((compilation-read-command nil))
    (projectile--run-project-cmd command projectile-compilation-cmd-map
            :show-prompt nil
            :prompt-prefix "Compile command: "
            :save-buffers t)))
#+end_src

#+begin_src emacs-lisp :results none
(defun +projectile/goto-project-root ()
  (interactive)
  (find-file (projectile-project-root)))
#+end_src

* Configure =magit=
#+begin_src emacs-lisp :results none
(use-package magit
  :straight t
  :defer t
  :commands (magit-status magit-branch magit-init magit-push)
  :config
    (setq magit-list-refs-sortby "-committerdate")
    
    (setq auto-revert-check-vc-info nil))

(use-package forge 
   :straight t  
   :after magit
   :config    
    (add-to-list 'forge-alist
                   '("gitlab.vpn.zowie.ai"
                     "gitlab.vpn.zowie.ai/api/v4"
                     "gitlab.vpn.zowie.ai"
                     forge-gitlab-repository))
)
#+end_src
 
vc-annotate options.
#+begin_src emacs-lisp :results none
;; (setq vc-git-annotate-switches '("-c"))
#+end_src

* Configure =eww=
#+begin_src emacs-lisp :results none
(use-package eww
  :straight nil
  :defer t
  :config 
    (evil-collection-define-key 'normal 'eww-mode-map
      "gt" #'tab-next
      "gT" #'tab-prev))

(defun +eww/browse-url (url &optional arg)
  (interactive
   (list
    (completing-read "Browse: " eww-prompt-history
		     nil nil nil 'eww-prompt-history)
    current-prefix-arg))
  (eww url (if arg 4 nil)))
#+end_src

* Configure =leetcode=

#+begin_src emacs-lisp :results none :tangle no
(use-package leetcode
   :straight t 
   :defer t
   :config
     (setq leetcode-prefer-language "python3")
     (setq leetcode-directory "~/leetcode"))
#+end_src

* Configure =git-timemachine=
 #+begin_src emacs-lisp :results none
(use-package git-timemachine 
 :straight (git-timemachine :type git :host codeberg :repo "pidu/git-timemachine" :branch "master")
 :commands (git-timemachine))
 #+end_src
 
* Configure =treemacs=
#+begin_src emacs-lisp :results none
(use-package treemacs 
   :straight t
   :defer t
   :config 
     (define-key treemacs-mode-map (kbd "SPC o p") #'treemacs)
     (setq treemacs-width 60))

(use-package treemacs-evil
  :straight t
  :after (evil treemacs) 
  :bind (:map evil-treemacs-state-map 
        ("SPC u" . #'universal-argument))
  :config
    (define-key evil-treemacs-state-map (kbd "SPC o p") #'treemacs))

(use-package treemacs-projectile
  :straight t
  :after (projectile treemacs))
#+end_src

* Configure =nano=
#+begin_src emacs-lisp :results none
(straight-use-package '(nano-splash :type git :host github
                                    :repo "rougier/nano-splash"))

(require 'nano-splash)
#+end_src

* Configure =mood-line=
SCHEDULED: <2024-04-29 Mon>

#+begin_src emacs-lisp :results none
(use-package mood-line
  :straight t
  :config
    (mood-line-mode)
  :custom
    (mood-line-glyph-alist mood-line-glyphs-fira-code))
#+end_src

* Configure =zoom-window=
 #+begin_src emacs-lisp :results none
(use-package zoom-window 
   :straight t
   :defer t
   :config
     (custom-set-variables
       '(zoom-window-mode-line-color "#6272a4")))
 #+end_src

* Completions

** =corfu=
#+begin_src emacs-lisp :results none
(use-package corfu
  :straight t
  ;; Optional customizations
  :custom
  (corfu-cycle t)                 ; Allows cycling through candidates
  (corfu-auto t)                  ; Enable auto completion
  (corfu-auto-prefix 2)
  (corfu-auto-delay 0.1)
  (corfu-popupinfo-delay '(0.5 . 0.1))
  (corfu-preview-current 'insert) ; insert previewed candidate
  (corfu-preselect 'prompt)
  (corfu-on-exact-match nil)      ; Don't auto expand tempel snippets
  ;; Optionally use TAB for cycling, default is `corfu-complete'.
  :bind (:map corfu-map
              ("M-SPC"      . corfu-insert-separator)
              ("TAB"        . corfu-next)
              ([tab]        . corfu-next)
              ("S-TAB"      . corfu-previous)
              ([backtab]    . corfu-previous)
              ("S-<return>" . corfu-insert)
              ("RET"        . corfu-insert))

  :init
  (global-corfu-mode)
  (corfu-history-mode)
  (corfu-popupinfo-mode) ; Popup completion info
  :config
  (add-hook 'eshell-mode-hook
            (lambda () (setq-local corfu-quit-at-boundary t
                                   corfu-quit-no-match t
                                   corfu-auto nil)
              (corfu-mode))
            nil
            t))
#+end_src

** =cape=
#+begin_src emacs-lisp :results none 
(use-package cape
  :straight t
  :after corfu
  :bind (("C-c p p" . completion-at-point) 
         ("C-c p t" . complete-tag)        
         ("C-c p d" . cape-dabbrev)        
         ("C-c p h" . cape-history)
         ("C-c p f" . cape-file)
         ("C-c p k" . cape-keyword)
         ("C-c p s" . cape-symbol)
         ("C-c p a" . cape-abbrev)
         ("C-c p i" . cape-ispell)
         ("C-c p l" . cape-line)
         ("C-c p w" . cape-dict)
         ("C-c p \\" . cape-tex)
         ("C-c p _" . cape-tex)
         ("C-c p ^" . cape-tex)
         ("C-c p &" . cape-sgml)
         ("C-c p r" . cape-rfc1345))
  :init
   ;; (setf (elt (cl-member 'lsp-completion-at-point completion-at-point-functions) 0)
   ;;       (cape-capf-buster #'lsp-completion-at-point))
   
   (add-to-list 'completion-at-point-functions (cape-company-to-capf #'company-yasnippet))
   (add-to-list 'completion-at-point-functions #'cape-dabbrev)
   (add-to-list 'completion-at-point-functions #'cape-file))
#+end_src

** =company=

#+begin_src emacs-lisp :results none
(use-package company
  :straight t
  :defer t
  :commands company-yasnippet)
#+end_src

** =vertico=
#+begin_src emacs-lisp :result none
(use-package vertico
  :straight t
  :init (vertico-mode))
#+end_src

#+begin_src emacs-lisp :result none
(use-package savehist
  :straight t
  :after vertico
  ;; :init (savehist-mode)
  :config
    (setq history-length 20))
#+end_src

#+begin_src emacs-lisp :result none
(use-package orderless
  :straight t
  :init
    (setq completion-styles '(orderless basic)
          completion-category-defaults nil
          completion-category-overrides '((file (styles partial-completion)))))
#+end_src

** =embark=
#+begin_src emacs-lisp :results none
(use-package embark
  :straight t
  :init
  ;; Optionally replace the key help with a completing-read interface
  (setq prefix-help-command #'embark-prefix-help-command)

  :config
  
  (global-set-key (kbd "C-a") #'embark-act)
  (global-set-key (kbd "C->") #'embark-become)
  
  (define-key embark-org-link-map (kbd "o") #'+org-open-at-point-other-window)
  (define-key embark-org-link-map (kbd "e") #'+org-link-at-point-open-externally)
  (define-key embark-general-map (kbd "z") #'embark-zeal)
  (define-key embark-general-map (kbd "i") #'+embark/insert-grep-line)
  (define-key embark-symbol-map (kbd "h") #'helpful-symbol)
  (define-key embark-file-map (kbd "l") #'+embark/create-link)
  (define-key embark-file-map (kbd "e") #'+embark/open-externally)
  
  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none))))


  (defun +embark/create-link (link)
    (let* ((beg-raw (re-search-backward " \\|^"))
           (_ (forward-char))
           (beg (if (looking-at-p " ")) (+ beg-raw 1) beg-raw)
           (end-raw (re-search-forward " \\|$"))
           (_ (backward-char))
           (end (if (looking-at-p " ") (- end-raw 1) end-raw)))

	(kill-region beg end)
      (org-insert-link link link (read-string "Description: " ""))))

  (defun +embark/open-externally (link)
    (call-process (open-command) nil 0 nil link))

  (require 'org-element)
  
  (defun +org-copy-link-at-point (_)
    (let* ((context (org-element-context))
           (ctx (cadr context))
           (link (plist-get ctx :raw-link)))
      (kill-new link)))

  (defun +org-link-at-point-open-externally (_)
    (let* ((context (org-element-context))
           (ctx (cadr context))
           (link (plist-get ctx :raw-link)))
      (call-process (open-command) nil 0 nil link)))
  
  (defun +org-open-at-point-other-window (_)
    (let ((org-link-frame-setup '((file . find-file-other-window))))
      (org-open-at-point))))
  
  ;; (add-to-list 'embark-target-finders 'org-link-finder)
  ;; (add-to-list 'embark-keymap-alist '(link . embark-org-link-map)))

(defun +embark/insert-grep-line (line)
  (interactive "sInsert: ")
  (let* ((trimmed (s-trim (->> (s-split ":" line) (-drop 2) (s-join ":"))))
         (result (if (equal "" trimmed) line trimmed)))

    (if buffer-read-only
        (with-selected-window (other-window-for-scrolling)
          (insert result))
      (insert result))))
#+end_src

#+begin_src emacs-lisp :results none
(defun lsp-find-in-side-window ()
  (interactive)
  (lsp-find-definition :display-action 'window))
#+end_src

** =marginalia=
#+begin_src emacs-lisp :results none
(use-package marginalia
  :straight t
  :commands (execute-extended-command)
  :init
    (marginalia-mode))
#+end_src

** =consult=
#+begin_src emacs-lisp :results none
(use-package consult
  :straight t
  :defer t
  :commands (execute-extended-command consult-find consult-line)
  :init
    (setq consult-fontify-preserve t)
    (setq consult-async-min-input 1)
    (setq consult-async-refresh-delay 0.1)

    (setq register-preview-delay 0
          register-preview-function #'consult-register-format)

    (advice-add #'register-preview :override #'consult-register-window)
    (advice-add #'consult-line :after (lambda (&rest r)
       (push (car consult--line-history) regexp-search-ring)))

    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)

    (global-set-key (kbd "C-c k") (lambda () (interactive) (consult-ripgrep default-directory)))
    (global-set-key (kbd "C-x b") #'consult-buffer)
    (global-set-key (kbd "C-s") #'consult-line) 

    ;; (setq consult-preview-key (list (kbd "M-n") (kbd "M-p")))

  :config
    (setq consult-narrow-key "<")

    (autoload 'projectile-project-root "projectile")
    (setq consult-project-root-function #'projectile-project-root))
#+end_src

#+begin_src emacs-lisp :results none
(use-package embark-consult
  :straight t
  :after (embark consult)
  :demand t 
  :hook
    (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

#+begin_src emacs-lisp :results none
(use-package consult-flycheck
  :straight t
  :after (consult flycheck))
#+end_src

#+begin_src emacs-lisp :results none
(use-package consult-projectile
  :load-path "~/.emacs.d/packages/consult-projectile/"
  :defer t
  :commands (consult-projectile))
#+end_src

* Configure =helpful=
 #+begin_src emacs-lisp :results none
 (use-package helpful
   :straight t
   :defer t)
 #+end_src

* Configure =keychain=
#+begin_src emacs-lisp :results none
(use-package keychain-environment
   :straight t
   :defer nil
   :config (keychain-refresh-environment))
#+end_src

* Configure =ox-html=
#+begin_src emacs-lisp :results no
(use-package ox-html
  :straight nil
  :config
    (setf (alist-get 'verbatim org-html-text-markup-alist) "<span class=\"verbatim\">%s</span>"))
#+end_src

* Configure =ox-slack=
#+begin_src emacs-lisp :results none :tangle no
(use-package ox-slack
  :straight t
  :defer t)
#+end_src

* Configure =emojify=
#+begin_src emacs-lisp :results none
(use-package emojify
  :straight t
  :bind (:map global-map
   (
    ("C-c SPC !" . (lambda () (interactive) (insert "❗")))
    ("C-c SPC ?" . (lambda () (interactive) (insert "❓")))
    ("C-c SPC W" . (lambda () (interactive) (insert "⚠️")))
    ("C-c SPC g" . (lambda () (interactive) (insert "🟢")))
    ("C-c SPC y" . (lambda () (interactive) (insert "🟡")))
    ("C-c SPC r" . (lambda () (interactive) (insert "🔴")))
    ("C-c SPC w" . (lambda () (interactive) (insert "⚪")))
    ("C-c SPC h" . (lambda () (interactive) (insert "👈")))
    ("C-c SPC k" . (lambda () (interactive) (insert "👆")))
    ("C-c SPC j" . (lambda () (interactive) (insert "👇")))
    ("C-c SPC l" . (lambda () (interactive) (insert "👉")))
    ("C-c SPC c" . (lambda () (interactive) (insert "✅")))
    ("C-c SPC x" . (lambda () (interactive) (insert "❌")))
    ("C-c SPC s" . (lambda () (interactive) (insert "🤷‍♂️")))
    ("C-c SPC t" . (lambda () (interactive) (insert "🤔")))))
  :config 
   (when (member "Noto Color Emoji" (font-family-list))
     (set-fontset-font
       t 'symbol (font-spec :family "Noto Color Emoji") nil 'prepend))

   (setq emojify-display-style 'unicode)
   (setq emojify-emoji-styles '(unicode))
  :hook (after-init . global-emojify-mode))
  #+end_src

* Configure =drag-stuff=
#+begin_src emacs-lisp :results none
(use-package drag-stuff
  :straight t
  :defer t)
#+end_src

* Configure =dired=
#+begin_src emacs-lisp :results none
(use-package dired 
  :straight nil
  :hook (dired-mode . dired-hide-details-mode)
  :config
   (defun +dired/copy-directory ()
     (interactive)
     (kill-new dired-directory))

   (setq dired-dwim-target t)

   (define-key dired-mode-map (kbd "C-x n n") #'dired-narrow)

   (evil-collection-define-key 'normal 'dired-mode-map
     "_" #'+projectile/goto-project-root
     "ge" #'+dired/open-externally
     "gu" #'+dired/unzip
     "gn" #'+dired/open-nautilus
     "yp" #'+dired/copy-path
     "yd" #'+dired/copy-dir-path
     "'" #'hydra-dired-bookmarks/body))
#+end_src

#+begin_src emacs-lisp :results none
(use-package dired-narrow
  :straight t
  :after dired-mode)
#+end_src

#+begin_src emacs-lisp :results none
(defun +dired/unzip ()
  (interactive)
  (let ((filename (dired-get-filename)))
     (print filename)
     (call-process "unzip" nil 0 filename)))

(defun open-command ()
  "open")

(defun +dired/open-externally ()
  (interactive)
  (let ((filename (dired-get-filename)))
  (if (s-starts-with? "/ssh" filename)
      (let ((dest (concat "/tmp/" (file-name-nondirectory filename))))
	(tramp-sh-handle-copy-file filename dest t)
	(call-process (open-command) nil 0 nil dest)))
     (call-process (open-command) nil 0 nil filename)))

(defun +dired/open-nautilus ()
  (interactive)
  (call-process "nautilus" nil 0 nil (expand-file-name default-directory)))

(defun +dired/copy-path ()
  (interactive)
  (kill-new (dired-get-filename)))

(defun +dired/copy-dir-path ()
  (interactive)
  (kill-new (dired-current-directory)))
#+end_src

#+begin_src emacs-lisp :results none
(use-package dirvish
  :straight t
  :ensure t
  :custom 
   (dirvish-attributes '(subtree-state all-the-icons))
  :config
   (setq dirvish-reuse-session t)
   (setq dired-recursive-deletes 'always)
   (setq delete-by-moving-to-thrash 'always)

   (dirvish-override-dired-mode)

   (evil-collection-define-key 'normal 'dired-mode-map
        "o" #'dirvish-quicksort))
#+end_src

#+begin_src emacs-lisp :results none
(use-package all-the-icons
  :straight t
  :ensure t)
#+end_src

* Configure =ediff=
#+begin_src emacs-lisp :results none
(use-package ediff
  :straight t 
  :defer t
  :config
    (setq ediff-window-setup-function 'ediff-setup-windows-plain)
    (setq ediff-split-window-function 'split-window-horizontally)
    (setq ediff-forward-word-function 'forward-char))
#+end_src

* Configure =smerge=
#+begin_src emacs-lisp :results none
(use-package smerge-mode
  :straight t
  :defer t
  :bind (:map smerge-mode-map 
    ("C-c m u" . smerge-keep-upper)
    ("C-c m l" . smerge-keep-lower)
    ("C-c m a" . smerge-keep-all)
    ("C-c m p" . smerge-prev)
    ("C-c m n" . smerge-next)))
#+end_src

* Languages
** Common
#+begin_src emacs-lisp :results none
(defface todo-comment-face
  '((t :foreground "#ff5555"
       :weight bold
       :underline t
       ))
  "TODO Comment Face")
#+end_src

** Dockerfile
#+begin_src emacs-lisp :results none
(use-package dockerfile-mode
  :straight t
  :defer t
  :config
    (add-to-list 'auto-mode-alist '("Dockerfile\\'" . dockerfile-mode)))
#+end_src
** Python
Setup =python-mode=.
#+begin_src emacs-lisp :results none
(use-package python-mode
   :straight t
   :defer t
   :init
     (font-lock-add-keywords 'python-mode
       '(("\\(TODO\\):" 1 'todo-comment-face prepend)))
      (setq python-indent-offset 4)
      (setq python-indent 4)
      (setq python-guess-indent nil)  
      (setq python-indent-guess-indent-offset t)  
      (setq python-indent-guess-indent-offset-verbose nil)
      (setq lsp-pyls-plugins-flake8-max-line-length 120)
      
      (setq python-shell-interpreter "ipython"
            python-shell-interpreter-args "-i --simple-prompt --InteractiveShell.display_page=True")
   :config
     
     (add-hook 'python-base-mode-hook 'flymake-mode)
     ;; (setq python-flymake-command '("ruff" "--quiet" "--stdin-filename=stdin" "-"))

     ;; automatically scroll the shell buffer 
     (add-hook 'inferior-python-mode-hook
          (lambda ()
            (setq comint-move-point-for-output t)))

     (add-hook 'python-mode-hook 
       (lambda () (push '("lambda" . "λ") prettify-symbols-alist))))
#+end_src
   
#+begin_src emacs-lisp :results none
(use-package pyvenv
  :straight t
  :defer t
  :config (pyvenv-mode t))

(defun +pyvenv-anaconda ()
  (interactive)
  (let* ((root-dir "/opt/anaconda3/envs")
           (dirs (directory-files root-dir t directory-files-no-dot-files-regexp))
           (chosen-dir (completing-read "Choose directory: " dirs nil t)))
     (pyvenv-activate chosen-dir)))

(defun +pyvenv-activate ()
  (interactive)
  (let* ((root (s-trim (shell-command-to-string "pyenv root")))
	 (env (s-trim (shell-command-to-string "pyenv local")))
	 (path (concat root "/" "versions" "/" env)))
    (pyvenv-activate path)))
#+end_src

#+begin_src emacs-lisp :results none
(use-package conda
  :straight t
  :after python-mode 
  :init
    (setq conda-env-home-directory "/opt/anaconda3/") 
  :config
    (conda-env-initialize-interactive-shells)
    (conda-env-initialize-eshell))
#+end_src

#+begin_src emacs-lisp :results none
(use-package blacken
  :straight t
  :hook (python-mode . blacken-mode))
#+end_src

#+begin_src emacs-lisp :results none
(use-package lsp-pyright
  :straight t
  :hook (python-mode . (lambda ()
                          (require 'lsp-pyright)
                          (lsp))))  ; or lsp-deferred
#+end_src

#+begin_src emacs-lisp :results none
(defun +python/surround-word-with-list ()
  (interactive)
  (+core/surround-word-with "List[" "]"))

(defun +python/surround-word-with-optional ()
  (interactive)
  (+core/surround-word-with "Optional[" "]"))
#+end_src
** R
#+begin_src emacs-lisp :results none
(use-package ess
  :straight t
  :defer t
  :config

   (defun clear-shell ()
     (interactive)
     (let ((old-max comint-buffer-maximum-size))
       (setq comint-buffer-maximum-size 0)
       (comint-truncate-buffer)
       (setq comint-buffer-maximum-size old-max))))
#+end_src

** Protobuf
#+begin_src emacs-lisp :results none
(use-package protobuf-mode
  :straight t 
  :defer t
  :config
    (defconst my-protobuf-style
      '((c-basic-offset . 4)
       (indent-tabs-mode . nil)))
    
     (add-hook 'protobuf-mode-hook 
       (lambda () (c-add-style "my-style" my-protobuf-style t))))
#+end_src
   
** LSP
#+begin_src emacs-lisp :results none
(use-package lsp-mode
   :straight t
   :hook ((typescript-mode . lsp-deferred)  
          (c-mode . lsp-deferred)
          (go-mode . lsp-deferred)
          (sh-mode . lsp-deferred)
          (lsp-completion-mode . my/lsp-mode-setup-completion))
   :custom
         (lsp-headerline-breadcrumb-enable nil)
         (lsp-diagnostic-clean-after-change t)
         (lsp-completion-provider :none)
         ;; (lsp-semantic-tokens-enable t)
         ;; (lsp-semantic-tokens-apply-modifiers nil)
   :init
         (setq lsp-use-plists t)
         (setq lsp-keymap-prefix "C-c l")

         (defun my/orderless-dispatch-flex-first (_pattern index _total)
            (and (eq index 0) 'orderless-flex))
        
          (defun my/lsp-mode-setup-completion ()
            (setf (alist-get 'styles (alist-get 'lsp-capf completion-category-defaults))
                  '(orderless)))
        
          (add-hook 'orderless-style-dispatchers #'my/orderless-dispatch-flex-first nil 'local)
    :config
          (setq lsp-prefer-flymake nil)
          (lsp-enable-which-key-integration t)
          (define-key lsp-mode-map (kbd "C-c l") lsp-command-map)
          (lsp-define-conditional-key lsp-command-map "ss" lsp "start server" t)
   :bind (
         (:map lsp-command-map
           ("a" . lsp-execute-code-action)
           ("f" . +lsp/fill-signature))
         (:map evil-normal-state-map 
           ("C-t" . lsp-signature-activate)
           ("M-w" . +lsp-ui/toggle-doc-focus)          
           ("C-<return>" . lsp-execute-code-action))
         (:map evil-insert-state-map
           ("C-l l f" . +lsp/fill-signature)
           ("C-t" . lsp-signature-activate)
           ("C-<return>" . lsp-execute-code-action))))
#+end_src

#+begin_src emacs-lisp :results none
(defun lsp-booster--advice-json-parse (old-fn &rest args)
  "Try to parse bytecode instead of json."
  (or
   (when (equal (following-char) ?#)
     (let ((bytecode (read (current-buffer))))
       (when (byte-code-function-p bytecode)
         (funcall bytecode))))
   (apply old-fn args)))
(advice-add (if (progn (require 'json)
                       (fboundp 'json-parse-buffer))
                'json-parse-buffer
              'json-read)
            :around
            #'lsp-booster--advice-json-parse)

(defun lsp-booster--advice-final-command (old-fn cmd &optional test?)
  "Prepend emacs-lsp-booster command to lsp CMD."
  (let ((orig-result (funcall old-fn cmd test?)))
    (if (and (not test?)                             ;; for check lsp-server-present?
             (not (file-remote-p default-directory)) ;; see lsp-resolve-final-command, it would add extra shell wrapper
             lsp-use-plists
             (not (functionp 'json-rpc-connection))  ;; native json-rpc
             (executable-find "emacs-lsp-booster"))
        (progn
          (when-let ((command-from-exec-path (executable-find (car orig-result))))  ;; resolve command from exec-path (in case not found in $PATH)
            (setcar orig-result command-from-exec-path))
          (message "Using emacs-lsp-booster for %s!" orig-result)
          (cons "emacs-lsp-booster" orig-result))
      orig-result)))
(advice-add 'lsp-resolve-final-command :around #'lsp-booster--advice-final-command)
#+end_src

#+begin_src emacs-lisp :results none
(use-package lsp-ui
  :straight t
  :after lsp-mode
  :config 
    (setq lsp-ui-doc-use-childframe nil)
    (setq lsp-ui-doc-enable nil)
    (add-to-list 'lsp-ui-doc-frame-parameters '(no-accept-focus . t))

    (setq dap-output-window-min-height 40)
    (setq dap-output-window-max-height 40))
#+end_src

#+begin_src emacs-lisp :results none
(use-package consult-lsp
  :straight t
  :after lsp-mode)
#+end_src

#+begin_src emacs-lisp :results none
(use-package lsp-metals
  :straight t
  :custom
    (lsp-metals-server-args '("-J-Dmetals.allow-multiline-string-formatting=off"
                              "-J-Dmetals.icons=unicode"))
    (lsp-metals-super-method-lenses-enabled t)
    (lsp-metals-enable-semantic-highlighting t)
  :after (lsp-mode scala-mode))
#+end_src

#+begin_src emacs-lisp :results none
(defun +lsp/get-errors-for-buffer ()
  (mapcar (lambda (el) (gethash "message" el))
    (gethash (buffer-file-name)
	     (lsp-diagnostics t))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +lsp-ui/toggle-doc-focus ()
  (interactive)
  (if (lsp-ui-doc--visible-p)
      (lsp-ui-doc-focus-frame)
      (lsp-ui-doc-unfocus-frame)))
#+end_src

#+begin_src emacs-lisp :results none
(defun +lsp/current-param-lookup ()
  (interactive)
  (let* ((beg (save-excursion (backward-up-list) (right-char) (point)))
         (end (save-excursion (up-list) (left-char) (point)))
         (region-str (s-trim (buffer-substring-no-properties beg end)))
         (param-strs (mapcar (lambda (p) (s-trim p)) (s-split "," region-str)))
         (lookup (mapcar (lambda (p) (s-split " = " p)) param-strs)))

    lookup))

(defun +lsp/fill-signature--clean ()
  (let* ((beg (save-excursion (backward-up-list) (right-char) (point)))
         (end (save-excursion (up-list) (left-char) (point))))
    (kill-region beg end)))

(defun +lsp/fill-signature--param-value (name lookup)
  (s-concat
     name
     " = "
     (or (nth 1 (assoc name lookup)) "???")
      ","))

(defun +lsp/fill-signature--handle (signature)
  (let* ((signatures (gethash "signatures" signature))
         (signature (elt signatures 0))
         (params (gethash "parameters" signature))
         (labels (mapcar (lambda (p) (gethash "label" p)) params))
         (label-names (mapcar (lambda (l) (s-replace "<" "" (car (s-split ":" l)))) labels))
         (lookup (+lsp/current-param-lookup)))

    (+lsp/fill-signature--clean)
    
    (insert
      (s-concat
        "\n"
        (s-join "\n" (mapcar (lambda (n) (+lsp/fill-signature--param-value n lookup)) label-names))
        "\n"))))

(defun +lsp/fill-signature ()
  (interactive)
  (if (and lsp--signature-last-buffer
          (not (equal (current-buffer) lsp--signature-last-buffer)))
      (lsp-signature-stop)
      (lsp-request-async "textDocument/signatureHelp"
                      (lsp--text-document-position-params)
                      #'+lsp/fill-signature--handle
                      :cancel-token :signature)))
#+end_src

#+begin_src emacs-lisp :results none
(defun +lsp/lsp-select-log-level()
  (interactive)
  (let* ((level-string (completing-read "Lsp log level" '("ERROR" "WARN" "INFO" "DEBUG")))
         (severity  (pcase level-string
                      (`"ERROR" 1)
                      (`"WARN" 2)
                      (`"INFO" 3)
                      (`"DEBUG" 5))))
    (when severity
      (setq lsp-treemacs-error-list-severity severity))
    (call-interactively 'lsp-treemacs-errors-list)))
#+end_src

Remove other LSP sessions.
#+begin_src emacs-lisp :results none
(defun +lsp/remove-other-sessions ()
    (interactive)
    (-each 
        (-remove-item
            (lsp-find-session-folder (lsp-session) default-directory)
            (lsp-session-folders (lsp-session)))
        #'lsp-workspace-folders-remove))
#+end_src
   
** Eglot 
#+begin_src emacs-lisp :results none
(use-package eglot
  :straight t
  :hook
  (python-mode . eglot-ensure)

  :config
  (add-hook 'eglot-managed-mode-hook
    (lambda () (cond ((derived-mode-p 'python-base-mode)
                      (add-hook 'flymake-diagnostic-functions 'python-flymake nil t))
                      ;; if not adding diagnostic functions to other modes just use an if
                      ;; ...
                     (t nil))))
  
  (setq-default eglot-workspace-configuration
                '((:pyright-langserver . (:configurationSources ["flake8"]
								:plugins (
									  :pycodestyle (:enabled :json-false)
									  :mccabe (:enabled :json-false)
									  :pyflakes (:enabled :json-false)
									  :flake8 (:enabled :json-false :maxLineLength 120)
									  :ruff (:enabled t :lineLength 120)
									  :pydocstyle (:enabled t :convention "numpy")
									  :yapf (:enabled :json-false)
									  :autopep8 (:enabled :json-false)
									  :black (:enabled t :line_length 120 :cache_config t)))))))

#+end_src

** Scala
scala-mode
#+begin_src emacs-lisp :results none
(use-package scala-mode
  :straight t
  :mode "\\.s\\(cala\\|bt\\|c\\)$"
  :hook
    ((scala-mode . lsp)
     (scala-mode . flycheck-mode))
     ;; (scala-mode . company-mode)
  :bind (:map scala-mode-map
        ("C-c C-c" . +scala/dwim-at-point))
  :config
    (font-lock-add-keywords 'scala-mode
      '(("\\(TODO\\):" 1 'todo-comment-face prepend)
        ("\\(NOTE\\):" 1 'bookmark-face prepend))))

(defun is-scala3-project ()
  (projectile-with-default-dir (projectile-project-root)
    (when (file-exists-p "build.sbt")
      (with-temp-buffer
        (insert-file-contents "build.sbt")
        (search-forward "scalaVersion := \"3" nil t)))))

(defun disable-scala-indent ()
  (when (is-scala3-project)
    (setq indent-line-function 'indent-relative-maybe)))

(add-hook 'scala-mode-hook #'disable-scala-indent)
#+end_src

sbt-mode
#+begin_src emacs-lisp :results none
(use-package sbt-mode
  :straight t
  :after scala-mode
  :commands sbt-start sbt-command
  :config
    (substitute-key-definition
       'minibuffer-complete-word
       'self-insert-command
        minibuffer-local-completion-map)

    (setq sbt:program-options '("-Dsbt.supershell=false")))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/copy-import ()
    (interactive)
    (setq import
      (replace-regexp-in-string "package" "import"
      (concat
        (car (split-string (buffer-string) "\n"))
        "."
        (thing-at-point 'word))))

    (message "Copied: %s" import)
    (kill-new import))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/create-test ()
  (interactive)

  (let* ((style (completing-read "Choose: " '("munit" "scalatest")))
	 (file-path (buffer-file-name))
	 (test-path
	  (replace-regexp-in-string "\\.scala" "Test.scala"
				    (replace-regexp-in-string "src/main/scala" "src/test/scala" file-path))))

    (shell-command (format "mkdir -p %s" (file-name-directory test-path)))
    (shell-command (format "touch %s" test-path))


    (with-current-buffer (find-file test-path)
      (if (string= style "munit")
	  (progn
	    (insert (format "class %sTest extends munit.FunSuite {\n\n}" (file-name-nondirectory (file-name-sans-extension file-path)))))

	(progn
	  (insert (format "import org.scalatest.wordspec.AnyWordSpec\n"))
	  (insert (format "import org.scalatest.matchers.should.Matchers\n\n"))
	  (insert (format "class %sTest extends AnyWordSpec with Matchers {\n\n}" (file-name-nondirectory (file-name-sans-extension file-path)))))
	
      (save-buffer)))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/match-imports ()
  (interactive)

  (ace-window nil)

  (let ((pos 0)
        (imports nil)
        (content (buffer-substring-no-properties (point-min) (point-max))))

    (while (string-match "^import.*" content pos)
      (setq pos (match-end 0))

      (let ((import (match-string 0 content)))
        (push import imports)))

    (ace-window nil)

    (beginning-of-buffer)
    (forward-line)

    (insert "\n")
    (dolist (import imports)
      (insert import)
      (insert "\n"))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/insert-package ()
  (interactive)

  (let* ((candidate-file (car (directory-files default-directory nil "^[^#]*\\.scala")))
	 (path (concat default-directory candidate-file))
         (package (with-current-buffer
       	    (or (get-file-buffer path)
       	        (find-file-noselect path))
       
               (buffer-substring-no-properties
       		   (progn (beginning-of-buffer) (point))
       		   (progn (next-line) (point))))))

    (beginning-of-buffer)
    (insert package)))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/make-s-string ()
  (interactive)
  (save-excursion
    (evil-find-char-backward 1 ?\")
    (insert "s")))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/def-in-file ()
  (interactive)
  (consult-line "def "))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/surround-word-with-list ()
  (interactive)
  (+core/surround-word-with "List[" "]"))

(defun +scala/surround-word-with-try ()
  (interactive)
  (+core/surround-word-with "Try[" "]"))
  
(defun +scala/surround-word-with-option ()
  (interactive)
  (+core/surround-word-with "Option[" "]"))
  
(defun +scala/surround-word-with-future ()
  (interactive)
  (+core/surround-word-with "Future[" "]"))

(defun +scala/surround-word-with-future-successful ()
  (interactive)
  (+core/surround-word-with "Future.successful(" ")"))
  
(defun +scala/surround-word-with-io ()
  (interactive)
  (+core/surround-word-with "IO[" "]"))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/dwim-at-point ()
  (interactive)
 
  (let ((word
           (save-excursion
             (beginning-of-line)
             (current-word))))

      (if (equal word "package")
	  (+scala/package-to-import)
	  (+scala/complete-type-param))))
  
(defun +scala/package-to-import ()
  (interactive)

  (beginning-of-line)
  (kill-word 1)
  (insert "import")
  (end-of-line)
  (delete-char -1))
    
(defun +scala/complete-type-param ()
  (interactive)

  (let ((arg-name (buffer-substring-no-properties
		   (progn (backward-word) (point))
		   (progn (forward-word) (point)))))
    (insert (concat ": "
                    (upcase (substring arg-name 0 1))
                    (substring arg-name 1 nil)
                    ","))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/declaration-to-assignment ()
  (interactive)
  (evil-ex (concat "'<,'>" "s/" "\\(\\w+\\):.*" "/" "\\1 = \\1,")))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/name-parameters ()
  (interactive)
  (evil-ex (concat "'<,'>" "s/" "\\w+\\.\\(\\w+\\)" "/" "\\1 = \\0")))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/reverse-pattern-match ()
  (interactive)
  (evil-ex (concat "'<,'>" "s/" "case \\(.*\\) => \\(.*\\)" "/" "case \\2 => \\1")))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/replace-with-filename ()
  (interactive)
  (let ((path (buffer-file-name)))
    (string-match ".*/\\(.*\\)\\.scala" path)
    (left-word 1)
    (kill-word 1)
    (insert (substring path (match-beginning 1) (match-end 1)))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/goto (path)
  (interactive)

  (require 's)
  (let* ((project-root (file-name-as-directory (projectile-project-root)))
         (root (s-chop-suffix "project/" project-root))
         (path (concat (file-name-as-directory root) path)))
    (find-file path)))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/fill-imports-from-side-buffers ()
  (interactive)

  (let* ((errors (-map #'flycheck-error-message flycheck-current-errors))
         (not-found (-filter (apply-partially #'s-starts-with? "not found:")  errors))
         (symbols (-map (-compose #'car (apply-partially #'-take-last 1) (apply-partially #'s-split " ")) not-found))
         (visible-buffers (-filter (lambda (b): (not (equal (buffer-name b) (buffer-name (current-buffer))))) (mapcar 'window-buffer (window-list)))))

    (print visible-buffers)))
#+end_src

#+begin_src emacs-lisp :results none
(defvar +scala/common-imports
  '("import scala.concurrent.duration._"
    "import scala.concurrent.duration.FiniteDuration"
    "import java.time.ZonedDateTime"
    "import java.time.Clock"
    "import scala.jdk.CollectionConverters._"
    "import com.typesafe.scalalogging.StrictLogging"
    "import cats.instances.future.catsStdInstancesForFuture"
    "import cats.instances.list.catsStdInstancesForList"
    "import cats.syntax.flatMap._"
    "import cats.syntax.functor._"
    "import cats.syntax.bifunctor._"
    "import cats.syntax.traverse._"
    "import cats.syntax.monad._"
    "import cats.syntax.applicativeError._"
    "import cats.syntax.monadError._"
    "import cats.syntax.applicative._"
    "import cats.syntax.apply._"
    "import cats.syntax.option._"
    "import cats.effect.IO"
    "import cats.effect.ContextShift"
    "import cats.effect.kernel.Ref"
    "import cats.effect.Resource"
    "import cats.effect.std.Dispatcher"
    "import cats.effect.unsafe.IORuntime"
    "import io.opentracing.Span"
    "import io.opentracing.Tracer"
    "import hero.common.logging.Logger"
    "import hero.common.logging.LoggingSupport"
    "import hero.common.util.time.TimeUtils.TimeProvider"
    "import hero.common.util.IdProvider"
    "import reactivemongo.api.indexes.Index"
    "import reactivemongo.api.indexes.IndexType"))

(defun +scala/insert-common-import (import)
  (interactive
   (list
    (completing-read " " +scala/common-imports)))

  (save-excursion 
    (goto-line 2)
    (move-to-column 1)
    (newline)
    (insert import)))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/importer ()
  (interactive)
  (let* ((path (projectile-project-root))
	 (executable "/Users/lukaszkazmierczak/projects/scala-importer/scala-importer")
	 (output (shell-command-to-string (format (s-concat executable " %s") path)))
         (imports (-filter (lambda (s) (not (equal (s-trim s) ""))) (s-split "\n" output)))
         (chosen-import (completing-read "Choose: " imports)))
    (if chosen-import
	(save-excursion
	  (beginning-of-buffer)
	  (forward-line)

	  (insert "\nimport ")
	  (insert chosen-import))
      (print "No import chosen!"))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/resolve-imports ()
  (interactive)

  (let* ((path (projectile-project-root))
	 (executable "/Users/lukaszkazmierczak/projects/scala-importer/scala-importer")
	 (output (shell-command-to-string (format (s-concat executable " %s") path)))
         (available (-concat
		     (-filter (lambda (s) (not (equal (s-trim s) ""))) (s-split "\n" output))
		     (-map (lambda (s) (s-replace "import " "" s)) +scala/common-imports)))
	 (missing
	  (-distinct 
	   (-map (lambda (s) (s-replace "not found: value " "" (s-replace "not found: type " "" s)))
		 (-filter (lambda (s) (s-starts-with? "not found: " s))
			  (+lsp/get-errors-for-buffer)))))
	 (imports
	  (-filter (lambda (s) (-any? (lambda (m) (s-ends-with? (concat "." m) s)) missing))
		   available)))
    
    (if imports
	(save-excursion
	  (beginning-of-buffer)
	  (forward-line)
	  (-each imports (lambda (i) (insert "\nimport ") (insert i))))
      (message "No imports to resolve"))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/used-proto ()
  (interactive)

  (with-current-buffer (find-file-noselect (concat (projectile-project-root) "build.sbt"))
    (let* ((pos 0)
           (paths nil)
           (content (buffer-substring-no-properties (point-min) (point-max)))
           (pattern "\sbaseDirectory\\.value \\(.*\\)\\|^\s*\"\\(.*\\)\""))
      
      (while (string-match pattern content pos)
        (setq pos (match-end 0))

        (let* ((match (or (match-string 1 content) (match-string 2 content)))
               (raw-path (s-replace-all '(("," . "") (" " . "") ("\"" . "")) match))
               (path (if (s-starts-with? "/" raw-path) (substring raw-path 1) raw-path)))
	  
	  (if (not (s-starts-with? "-" path))
	      (push path paths))))

      (let ((choice (completing-read " " paths)))
        (if choice
            (find-file (concat (projectile-project-root) choice)))))))
#+end_src

** Yaml
#+begin_src emacs-lisp :results none
(use-package yaml-mode 
  :straight t
  :defer t)
#+end_src

** Elisp
#+begin_src emacs-lisp :results none
(use-package emacs
  :straight nil
  :bind
    (:map emacs-lisp-mode-map
      ("C-c i" . indent-region))
  :config
    (font-lock-add-keywords 'emacs-lisp-mode
          		  '(("\\(TODO\\):" 1 'todo-comment-face prepend)))

    (add-hook 'emacs-lisp-mode-hook 
              (lambda () (progn
          		 (push '("lambda" . "λ") prettify-symbols-alist)
          		 (prettify-symbols-mode 1)))))
#+end_src

#+begin_src emacs-lisp :results none
(use-package rainbow-delimiters
  :straight t
  :hook ((emacs-lisp-mode . rainbow-delimiters-mode)
	 (scala-mode . rainbow-delimiters-mode)))
#+end_src

** Java

#+begin_src emacs-lisp :results none
(use-package lsp-java
  :straight t
  :config (add-hook 'java-mode-hook 'lsp))
#+end_src

** JavaScript
#+begin_src emacs-lisp :results none
(use-package js-mode
  :straight nil
  :defer t
  :config
    (setq js-indent-level 2) 
    (font-lock-add-keywords 'js-mode
       '(("(TODO\\):" 1 'todo-comment-face prepend))))
#+end_src

#+begin_src emacs-lisp :results none
(use-package prettier-js
  :straight t
  :hook (js-mode . prettier-js-mode) 
  :defer t
  :init
    (setq js-indent-level 2))
#+end_src

** TypeScript
#+begin_src emacs-lisp :results none
(use-package typescript-mode
  :straight t
  :mode "\\.\\(ts\\|tsx\\)$"
  :init
    (setq typescript-indent-level 2)
  :hook (typescript-mode . prettier-js-mode))
#+end_src

** GraphQL
#+begin_src emacs-lisp :results none
(use-package graphql-mode
  :straight t
  :defer t)
#+end_src

#+begin_src emacs-lisp :results none
(use-package request
  :straight t
  :defer t)
#+end_src

** PlantUML
#+begin_src emacs-lisp :results none
(use-package plantuml-mode
  :straight t
  :defer t 
  :config
    (setq plantuml-jar-path "/home/porcupine/tools/plantuml.jar")
    (setq plantuml-output-type "png")
    (setq plantuml-default-exec-mode 'jar))
#+end_src

** tree-sitter
#+begin_src emacs-lisp :results none
(use-package treesit-auto
  :straight t
  :config
  (global-treesit-auto-mode))
#+end_src

#+begin_src emacs-lisp :results none
(use-package tree-sitter
  :straight t
  :defer t
  :delight " tree"
  :init
    (global-tree-sitter-mode)
    (add-hook 'tree-sitter-after-on-hook #'tree-sitter-hl-mode)

  :hook ((python-mode . (lambda () (tree-sitter-mode) (tree-sitter-hl-mode)))
         (scala-mode . (lambda () (tree-sitter-mode) (tree-sitter-hl-mode)))))
#+end_src

#+begin_src emacs-lisp :results none 
(use-package tree-sitter-langs
  :straight t
  :after tree-sitter)
#+end_src

*** ts-fold

#+begin_src emacs-lisp :results none
(use-package ts-fold
  :straight (ts-fold :type git :host github :repo "emacs-tree-sitter/ts-fold")
  :init
    (setq global-ts-fold-mode t)	
    (define-key evil-normal-state-map (kbd "zc") #'ts-fold-close)
    (define-key evil-normal-state-map (kbd "zC") #'ts-fold-close-all)
    (define-key evil-normal-state-map (kbd "zo") #'ts-fold-open)
    (define-key evil-normal-state-map (kbd "zO") #'ts-fold-open-all))
#+end_src

** Fish
#+begin_src emacs-lisp :results none
(use-package fish-mode
  :straight t
  :defer t
  :mode "\\.fish$")
#+end_src

** Go

#+begin_src emacs-lisp :resuts none
(use-package go-mode
  :straight t
  :mode "\\.go$")
#+end_src

* Configure =format-all=
#+begin_src emacs-lisp :results none
(use-package format-all
  :straight t
  :defer t
  :hook (c-mode . format-all-mode))
#+end_src

* Configure =dumb-jump=
#+begin_src emacs-lisp :results none
(use-package dumb-jump
  :straight t
  :init
    (add-hook 'xref-backend-functions #'dumb-jump-xref-activate))
#+end_src

* Configure =direnv=
#+begin_src emacs-lisp :results none
;; (use-package direnv
;;  :straight t
;;  :config
;;    (setq direnv-always-show-summary nil)

;;    (add-to-list 'direnv-non-file-modes 'vterm-mode)
;;    (add-to-list 'direnv-non-file-modes 'dirvish)

;;    (direnv-mode))

;; (use-package envrc
;;   :straight t
;;   :config
;;     (envrc-global-mode))
#+end_src

* Configure =Info=
#+begin_src emacs-lisp :results none
(use-package info
  :straight nil
  :defer t
  :config
    (evil-collection-define-key 'normal 'Info-mode-map
        (kbd "gt") #'persp-next
        (kbd "gT") #'persp-prev))
  ;; :bind (:map evil-normal-state-map
  ;;   ("RET" . 'Info-follow-nearest-node)))
#+end_src

* Configure =smartparens=
#+begin_src emacs-lisp :results none
(use-package smartparens
  :straight t
  :hook (prog-mode . smartparens-mode)
  :config
    (smartparens-global-mode t)
    (show-smartparens-global-mode t)
    ;; (smartparens-global-strict-mode t)
  :bind (:map smartparens-mode-map
    ("M-l" . sp-forward-slurp-sexp)
    ("M-h" . sp-forward-barf-sexp)
    ("M-S-l" . sp-backward-slurp-sexp)
    ("M-S-h" . sp-backward-barf-sexp)))

(use-package evil-smartparens
  :straight t
  :after smartparens
  :hook (smartparens-mode . evil-smartparens-mode)
  :config
    (define-key global-map (kbd "<M-l>") nil)
    (require 'smartparens-config))
#+end_src

* Configure =csv-mode=
#+begin_src emacs-lisp :results none
(use-package csv-mode
  :straight t
  :defer t)
#+end_src

* Configure =eshell=
#+begin_src emacs-lisp :results none
(use-package eshell
  :straight nil 
  :defer t
  :hook (eshell-first-time-mode . +eshell/configure-eshell)
  :config
    ;; (company-mode -1)

    (defalias 'e "find-file-other-window $1")
    (defalias 'gs "git status")

    (defun +eshell/clear ()
      (interactive)
      (eshell/clear 1)
      (eshell-send-input)
      (evil-insert nil))

    (defun +eshell/open-in-default ()
      (interactive)
      (let ((current-dir default-directory))
        (eshell)
        (eshell/cd current-dir)
        (+eshell/clear)))

    (defun +eshell/open-in-project-root ()
      (interactive)
      (eshell)
      (eshell/cd (projectile-project-root))
      (+eshell/clear))

    (defun +eshell/configure-eshell ()
      ;; (evil-define-key '(normal insert visual) eshell-mode-map (kbd "C-r") 'counsel-esh-history)
      (evil-define-key '(normal insert visual) eshell-mode-map (kbd "C-l") '+eshell/clear)
      (evil-normalize-keymaps)

      (add-to-list 'eshell-output-filter-functions 'eshell-truncate-buffer)

      ;; (company-mode -1)

      (setq eshell-history-size              10000
            eshell-buffer-maximum-lines      10000
            eshell-hist-ignoredups           t
            eshell-scroll-to-bottom-on-input t)))
#+end_src

* Configure =vterm=
#+begin_src emacs-lisp :results none
(use-package vterm
  :straight t
  :defer t
  :config 
   (setq vterm-buffer-name-string "vterm - %s"))
#+end_src

#+begin_src emacs-lisp :results none
(defun +vterm/new-session ()
  (interactive)
  (vterm))

(defun +vterm/focus-or-create () 
  (interactive)

  (let ((vterm-buffers (-filter
  			(lambda (b) (s-starts-with-p "vterm" b))
  			(-map 'buffer-name (buffer-list)))))
    
    (cond
     ((= (length vterm-buffers) 0) (+vterm/new-session))
     ((= (length vterm-buffers) 1) (switch-to-buffer (car vterm-buffers)))
     (t (switch-to-buffer (completing-read "Choose: " vterm-buffers))))))
#+end_src

* Configure =elfeed=
#+begin_src emacs-lisp :results none
(use-package elfeed
  :straight t
  :defer t
  :commands
    (elfeed)
  :custom
    (elfeed-search-remain-on-entry t)
  :config
    (load-file "~/.emacs.d/packages/pelfeed.el")
    (p/elfeed-setup)

    (setq-default elfeed-search-filter "@6-months-ago +unread")

    (evil-collection-define-key 'normal 'elfeed-search-mode-map
      (kbd "RET") 'p/elfeed-show-entry
      ;; TODO: use general for that?
      "d" 'p/fetch-arxiv-paper
      "N" 'p/elfeed-roam-note
      "b" 'p/elfeed-browse-url
      "R" 'elfeed-update))
      #+end_src

#+begin_src emacs-lisp :results none :tangle no
(use-package elfeed-score
  :straight t
  :after elfeed
  :config
    (elfeed-score-enable)
    (define-key elfeed-search-mode-map "=" elfeed-score-map))
#+end_src
  
* Configure =winner=
#+begin_src emacs-lisp :results none
(use-package winner
  :straight nil
  :defer 10
  :config 
    (winner-mode))
#+end_src

* Configure =string-inflection=
#+begin_src emacs-lisp :results none
(use-package string-inflection 
  :straight t
  :defer t)
#+end_src

* Configure =eval-expr=
#+begin_src emacs-lisp :results none
(use-package eval-expr
   :straight t
   :defer t)
#+end_src

* Configure =pdf-tools=
#+begin_src emacs-lisp :results none 
(use-package pdf-tools
  :straight t
  :defer t
  :mode "\\.pdf$"
  :init
  (setenv "PKG_CONFIG_PATH" "/usr/lib/pkgconfig:/usr/share/pkgconfig")
  (pdf-loader-install)
  :config 
  (setq pdf-view-midnight-colors '("#839496" . "#1c2128")) 
  (add-hook 'pdf-view-mode-hook #'+pdf/setup)

  (add-hook 'pdf-view-mode-hook
	    (lambda ()
              (setq cursor-in-non-selected-windows nil)))
  ;; TODO: need to find a way to disable it
  ;; (internal-show-cursor nil nil))

  (defun +pdf/open-externally ()
    (interactive)
    (call-process (open-command) nil 0 nil (buffer-file-name)))

  (defun +pdf/setup ()
    (evil-collection-define-key 'normal 'pdf-view-mode-map
      "ge" #'+pdf/open-externally)

    (pdf-tools-install)
    (hide-mode-line-mode)))
#+end_src

* Configure =olivetti=
#+begin_src emacs-lisp :results none
(use-package olivetti
  :straight t
  :defer t
  :commands olivetti-mode
  :custom
    (olivetti-body-width 200)
    (olivetti-recall-visual-line-mode-entry-state t))
#+end_src

#+begin_src emacs-lisp :results none
(use-package hide-mode-line
  :straight t 
  :defer t
  :config
    (hide-mode-line-mode))
#+end_src

* Configure =eros=
#+begin_src emacs-lisp :results none
(use-package eros
  :straight t
  :defer t
  :hook (emacs-lisp-mode . eros-mode))
#+end_src

* Configure =vundo=
#+begin_src emacs-lisp :results none
(use-package vundo
  :straight t
  :defer t)
#+end_src

* Configure =tramp=
#+begin_src emacs-lisp :results none
(use-package tramp
  :straight nil
  :defer t
  :config
    (setq tramp-default-method "rsync"))
#+end_src

* Configure =delight=
#+begin_src emacs-lisp :results none
(use-package delight
  :straight t
  :defer t
  :config
    (delight '((conf-windows-mode "" ""))))
#+end_src

* Configure =svg-lib=
#+begin_src emacs-lisp :results none
(use-package svg-lib
 :straight t
 :defer t)
#+end_src

* Configure =origami-mode=
#+begin_src emacs-lisp :results none
;; (use-package origami
;;   :straight (origami :type git :host github :repo "elp-revive/origami.el" :branch "master")
;;   :defer t
;;   :hook ((js-mode . origami-mode)
;;          (scala-mode . origami-mode))
;;   :config
;;     (define-key evil-normal-state-map (kbd "zc") #'origami-close-node)
;;     (define-key evil-normal-state-map (kbd "zC") #'origami-close-all-nodes)
;;     (define-key evil-normal-state-map (kbd "zo") #'origami-open-node)
;;     (define-key evil-normal-state-map (kbd "zO") #'origami-open-all-nodes))
#+end_src

* Configure =mu4e=
#+begin_src emacs-lisp :results none :tangle no
(use-package mu4e
  :disabled t
  :straight nil
  ;; :load-path "~/.nix-profile/share/emacs/site-lisp/mu4e"
  :load-path "/usr/share/emacs/site-lisp/mu4e"

  :config 
    (setq mu4e-change-filenames-when-moving t)
    (setq mu4e-update-interval 60)
    (setq mu4e-hide-index-messages t)
    (setq mu4e-get-mail-command "mbsync -a")
    (setq mu4e-maildir "~/.mail")

    (setq mu4e-context-policy 'pick-first)

    (setq mu4e-contexts
           (list
             ;; Work account
             (make-mu4e-context
              :name "Work"
              :match-func
                (lambda (msg)
                  (when msg
                    (string-prefix-p "/Zowie" (mu4e-message-field msg :maildir))))
              :vars '((user-mail-address . "lukasz.kazmierczak@zowie.ai")
                      (user-full-name    . "Łukasz Kaźmierczak")
                      (mu4e-drafts-folder  . "/Zowie/[Gmail]/Drafts")
                      (mu4e-sent-folder  . "/Zowie/[Gmail]/Sent Mail")
                      (mu4e-refile-folder  . "/Zowie/[Gmail]/All Mail")
                      (mu4e-trash-folder  . "/Zowie/[Gmail]/Trash")))

             (make-mu4e-context
              :name "Private"
              :match-func
                (lambda (msg)
                  (when msg
                    (string-prefix-p "/Private" (mu4e-message-field msg :maildir))))
              :vars '((user-mail-address . "luki.pol@gmail.com")
                      (user-full-name    . "Łukasz Kaźmierczak")
                      (mu4e-drafts-folder  . "/Private/[Gmail]/Drafts")
                      (mu4e-sent-folder  . "/Private/[Gmail]/Sent Mail")
                      (mu4e-refile-folder  . "/Private/[Gmail]/All Mail")
                      (mu4e-trash-folder  . "/Private/[Gmail]/Trash")))))

    (setq mu4e-maildir-shortcuts
        '(("/Private/[Gmail]/All Mail" . ?p)
          ("/Zowie/[Gmail]/All Mail"   . ?w)))

    (setq user-mail-address "lukasz.kazmierczak@zowie.ai")
    (setq user-full-name "Łukasz Kaźmierczak")

    (setq smtpmail-smtp-server "smtp.gmail.com")
    (setq smtpmail-smtp-service 587)
    (setq smtpmail-stream-type 'starttls)

    (setq message-send-mail-function 'smtpmail-send-it))
#+end_src

* Configure =general=
#+begin_src emacs-lisp :results none
(use-package general
  :straight t
  :init
  (setq general-override-states '(insert
                                  emacs
                                  hybrid
                                  normal
                                  visual
                                  motion
                                  operator
                                  replace))
  :config
  (general-create-definer leader-def 
    :prefix "SPC")
  
  (leader-def
    :states '(normal visual motion)
    :keymaps 'override
    "0" #'toggle-frame-fullscreen

    "a a" #'org-agenda
    "a c" #'open-calendar
    "a w" #'+agenda/weekly-agenda
    "a d" #'+agenda/daily-agenda
    "a t" #'+agenda/filter-by-tag
    "a h" #'+agenda/filter-by-tag-hot
    
    "b a" #'bookmark-set
    "b b" #'consult-bookmark
    "b c" (lambda () (interactive) (switch-to-buffer "*compilation*"))
    "b C" (lambda () (interactive) (switch-to-buffer-other-window "*compilation*"))
    "b n" #'next-buffer
    "b s" #'+core/summon-scratch
    "b N" #'+core/scratch-buffer
    "b p" #'previous-buffer
    "b k" #'kill-current-buffer
    
    "c e" #'consult-flycheck
    "c E" #'consult-compile-error
    "c x" #'flycheck-list-errors
    "c c" #'compile
    "c C" #'recompile

    "d" #'hydra-dired-bookmarks/body

    "e e" #'elfeed
    "e d" #'ediff
    "e b" #'ediff-buffers
    
    "f f" #'find-file
    "f r" #'consult-recent-file
    "f i" (lambda () (interactive)(find-file "~/Dropbox/org/todo/inbox.org"))
    "f w" (lambda () (interactive)(find-file "~/Dropbox/org/todo/work.org"))
    "f W" (lambda () (interactive)(find-file "~/Dropbox/org/work/work.org"))
    "f p" (lambda () (interactive)(find-file "~/Dropbox/org/todo/private.org"))
    "f P" (lambda () (interactive)(find-file "~/Dropbox/org/knowledge/private.org"))
    "f e" (lambda () (interactive)(find-file "~/Dropbox/org/resources/resources.org"))
    "f C" (lambda () (interactive)(find-file "~/Dropbox/org/knowledge/cheatsheet.org"))
    "f D" (lambda () (interactive)(find-file "~/Dropbox/org/todo/work-daily.org"))
    "f s" (lambda () (interactive)(find-file "~/Dropbox/org/todo/studies.org"))
    "f S" (lambda () (interactive)(find-file "~/dotfiles/scripts"))
    "f d" (lambda () (interactive)(dired "~/dotfiles"))
    "f c" (lambda () (interactive)(find-file "~/.emacs.d/configuration.org"))
    "f y" (lambda () (interactive)(find-file "~/youtube/"))
    "f n" (lambda () (interactive)(find-file "~/dotfiles/config/nix/home.nix"))
    "f t" (lambda () (interactive)(find-file "~/.emacs.d/themes/noctilux-theme.el"))
    "f x" (lambda () (interactive)(find-file "~/.config/yabai/yabairc"))
    "f X" (lambda () (interactive)(find-file "~/.config/skhd/skhdrc"))
    
    "g b" #'magit-branch
    "g g" #'magit-status
    "g i" #'magit-init
    "g p" #'magit-push
    "g r" #'hydra-forge/body
    "g t" #'git-timemachine
    "g m" #'man
    
    "h b" #'counsel-descbinds
    "h k" #'helpful-key
    "h f" #'helpful-function
    "h F" #'describe-face
    "h v" #'helpful-variable
    "h p" #'helpful-package
    "h m" #'describe-mode
    "h M" #'helpful-macro
    "h e" #'view-echo-area-messages
    "h l" #'find-library
    
    "k" #'consult-yank-from-kill-ring

    "m f" #'memo/create-flashcard
    
    "l b" #'lsp-metals-build-import
    "l d" #'lsp-find-definition
    "l s" #'lsp-describe-session
    "l e" #'lsp-ui-flycheck-list
    "l l" #'consult-lsp-symbols
    "l T" #'lsp-treemacs-errors-list
    "l r" #'lsp-find-references
    "l R" #'lsp-rename
    "l x" #'+lsp/remove-other-sessions
    "l i" #'lsp-goto-implementation
    "l f" (lambda () (interactive) (if (derived-mode-p 'scala-mode) (lsp-format-buffer) (format-all-buffer)))
    "l I" #'+scala/copy-import
    
    "o c" #'cfw:open-org-calendar
    "o p" #'treemacs
    "o e" #'eshell
    "o E" #'+eshell/open-in-default
    "o P" #'+eshell/open-in-project-root
    "o o" #'olivetti-mode
    "o v" #'+vterm/focus-or-create
    "o V" #'+vterm/new-session
    "o m" #'mu4e
    "o w" #'+eww/browse-url
    
    "p a" #'projectile-add-known-project
    "p c" #'projectile-compile-project
    "p C" #'projectile-repeat-last-command
    "p f" (lambda () (interactive) (consult-ripgrep (projectile-project-root)))
    "p p" #'consult-projectile
    "p i" #'projectile-invalidate-cache
    "p t" #'treemacs-add-and-display-current-project
    "p T" #'+projectile/search-todos
    "p s" #'projectile-save-project-buffers
    "p w" #'+projectile/search-word-under-cursor
    
    "r j" (lambda () (interactive) (evil-window-decrease-height 30))
    "r k" (lambda () (interactive) (evil-window-increase-height 30))
    "r h" (lambda () (interactive) (evil-window-decrease-width 50))
    "r l" (lambda () (interactive) (evil-window-increase-width 50))
    "r =" #'balance-windows
    
    "s m" #'+work/consult-monorepo
    "s M" #'+work/consult-monorepo-glob
    "s f" #'+work/consult-find-file-monorepo
    
    "t r" #'+core/reload-theme
    "t t" #'+core/toggle-darkmode
    "t e" #'treemacs-display-current-project-exclusively
    
    "u" #'universal-argument
    
    "w u" #'winner-undo
    "w r" #'winner-redo
    "w f" #'+core/to-floating-frame
    "w l" #'+core/to-regular-right-window
    "w j" #'+core/to-regular-bottom-window
    
    "y a" #'yas-new-snippet
    "y v" #'yas-visit-snippet-file
    ;; "y c" #'company-yasnippet
    "y p" #'+core/copy-file-path
    
    "RET" #'consult-bookmark
    "`" #'popper-toggle-type
    
    "TAB c" #'tabspaces-switch-or-create-workspace
    "TAB d" #'tabspaces-kill-buffers-close-workspace
    "TAB n" #'tabspaces-switch-or-create-workspace
    "TAB k" #'tabspaces-kill-buffers-close-workspace
    "TAB TAB" #'tab-bar-mode
    
    "SPC" (lambda () (interactive) (consult-find default-directory))
    "," #'consult-projectile
    "'" #'hydra-dired-bookmarks/body)
  
  (leader-def
    :states '(normal visual motion)
    :keymaps 'eglot-mode-map
    "l d" #'xref-find-definitions)

  (general-create-definer local-leader-def
    :prefix "SPC m")

  (local-leader-def
    :states 'normal
    :keymaps 'org-mode-map
    "o" #'+ocr/screenshot
    "r" #'rsvp/read-from-ocr
    "R" #'rsvp/read-last-content
    "s" #'org-schedule
    "S" #'pscreenshot/org-screenshot-take
    "d" #'org-deadline
    "p" #'p/force-publish-current-file
    "P" #'p/show-current-currently-published-file
    "i" #'+org/save-image-insert-link
    "t" #'org-todo
    "a" #'org-expiry-insert-created)

  (local-leader-def
    :states 'normal
    :keymaps 'yaml-mode-map
    "u" #'+work/update-versions
    "s" #'+work/sync-env)
  
  (local-leader-def
    :states 'normal
    :keymaps 'text-mode-map
    "o" #'+ocr/screenshot)

  (local-leader-def
    :states 'normal
    :keymaps 'scala-mode-map
    "a" #'lsp-avy-lens
    "m" #'lsp
    "i" #'+scala/copy-import
    "y" #'+scala/fill-imports-from-side-buffers
    "s" #'hydra-scala-surround/body
    "l" #'+scala/importer
    "L" #'+scala/insert-common-import
    "r" #'+scala/resolve-imports
    "d" #'+scala/def-in-file
    "p" #'+scala/insert-package
    "t" #'lsp-metals-toggle-show-inferred-type
    "T" #'+scala/create-test
    "c b" (lambda () (interactive) (+projectile/compile "sbt bloopInstall"))
    "c c" (lambda () (interactive) (+projectile/compile "bl"))
    "c p" (lambda () (interactive) (+projectile/compile "protob"))
    "c n" (lambda () (interactive) (+projectile/compile "bl -n"))
    "c r" (lambda () (interactive) (+projectile/compile "bl -r"))
    "c t" (lambda () (interactive) (+projectile/compile "bl -t"))
    "c T" #'+scala/test
    "g c" (lambda () (interactive) (+scala/goto "src/main/resources/app.conf"))
    "g b" (lambda () (interactive) (+scala/goto "build.sbt"))
    "g d" (lambda () (interactive) (+scala/goto "project/Dependencies.scala"))
    "g v" (lambda () (interactive) (+scala/goto "project/DependencyVersions.scala"))
    "g p" (lambda () (interactive) (+work/goto-proto))
    "g u" (lambda () (interactive) (+scala/used-proto)))
  
  (local-leader-def
    :states 'normal
    :keymaps '(scala-mode-map conf-unix-mode)
    "g c" (lambda () (interactive) (+scala/goto "src/main/resources/app.conf"))
    "g b" (lambda () (interactive) (+scala/goto "build.sbt"))
    "g d" (lambda () (interactive) (+scala/goto "project/Dependencies.scala"))
    "g v" (lambda () (interactive) (+scala/goto "project/DependencyVersions.scala"))
    "g p" (lambda () (interactive) (+work/goto-proto))
    "g u" (lambda () (interactive) (+scala/used-proto)))

  (general-def :states 'normal :keymaps 'dired-mode-map "SPC" nil)

  (local-leader-def
    :states 'normal
    :keymaps 'dired-mode-map
    "g b" (lambda () (interactive) (+scala/goto "build.sbt"))
    "g d" (lambda () (interactive) (+scala/goto "project/Dependencies.scala"))
    "g v" (lambda () (interactive) (+scala/goto "project/DependencyVersions.scala"))
    "g p" (lambda () (interactive) (+work/goto-proto)))

  (local-leader-def
    :states 'normal
    :keymaps 'protobuf-mode-map
    "g b" (lambda () (interactive) (+scala/goto "build.sbt"))
    "g d" (lambda () (interactive) (+scala/goto "project/Dependencies.scala"))
    "g v" (lambda () (interactive) (+scala/goto "project/DependencyVersions.scala")))

  (local-leader-def
    :states 'normal
    :keymaps 'rust-mode-map
    "c c" #'rust-compile
    "c r" #'rust-run)

  (local-leader-def
    :states 'normal
    :keymaps 'python-mode-map
    "m" #'lsp
    "s" #'run-python
    "s" #'hydra-python-surround/body)

  (general-define-key 
   :prefix "SPC j"
   :states 'normal
   :keymaps 'org-mode-map
   "a" (lambda () (interactive) (jupyter-org-insert-src-block nil current-prefix-arg))
   "b" (lambda () (interactive) (jupyter-org-insert-src-block t current-prefix-arg))
   "x" #'jupyter-org-kill-block-and-results
   "c" #'org-babel-remove-result
   "j" #'org-babel-next-src-blok
   "k" #'org-babel-previous-src-block)
  
  (general-define-key 
   :prefix "SPC h"
   :states 'normal
   :keymaps 'org-mode-map
   "w" #'widen
   "s" (lambda () (interactive)
	 (progn
	   (evil-window-vsplit)
	   (org-tree-to-indirect-buffer))))

  (general-define-key 
   :prefix "SPC ;"
   :states '(normal visual)
   :keymaps 'override
   ";" #'copilot-chat-transient
   "q" (lambda ()
         (interactive)
         (copilot-chat-reset)
         (copilot-chat-display))
   "p" #'copilot-chat-switch-to-buffer
   "r" #'copilot-chat-reset
   "f" #'copilot-chat-add-file
   "w" #'copilot-chat-add-buffers-in-current-window
   ";" #'copilot-chat-transient
   "p" #'copilot-chat-switch-to-buffer
   "r" #'copilot-chat-reset
   "f" #'copilot-chat-add-file
   "w" #'copilot-chat-add-buffers-in-current-window
   "y" #'copilot-chat-yank
   "b" #'copilot-chat-add-current-buffer)

  (general-define-key 
   :prefix "C-c r"
   :states 'normal
   :keymaps '(evil-org-mode-map org-mode-map)
   "t" #'org-roam-tag-add)

  (general-define-key 
   :prefix "C-c j"
   :states 'normal
   :keymaps '(evil-org-mode-map org-mode-map)
   "p" #'org-roam-dailies-goto-yesterday
   "n" #'org-roam-dailies-goto-tomorrow)

  (general-define-key 
   :states '('normal 'insert)
   :keymaps '(evil-org-mode-map org-mode-map)
   "C-<return>" '+org/c-ret-dwim
   "S-<return>" '+org/s-ret-dwim
   "C-S-<return>" '+org/c-s-ret-dwim
   "C-M-<return>" '+org/c-m-ret-dwim
   "C-c e e" #'org-excalidraw-create-drawing)

  (general-define-key 
   :states '('normal)
   :keymaps '(evil-org-mode-map org-mode-map)
   "C-<return>" '+org/c-ret-dwim
   "C-c q" #'hydra-gpt/body
   "<return>" '+org/ret-dwim))
#+end_src

* Configure =nov=
#+begin_src emacs-lisp :results none
(use-package nov
  :straight t
  :mode ("\\.epub\\'" . nov-mode)
  :hook
    ((nov-mode . olivetti-mode)
     (nov-mode . (lambda () (setq header-line-format '("")))))
  :bind
    (:map nov-mode-map
     ("SPC" . 'ignore)
     ("g" . 'ignore)
     ("v" . 'ignore)
     ("[" . 'ignore)
     ("]" . 'ignore)
     ("p" . 'ignore)
     ("k" . 'ignore)
     ("j" . 'ignore)
     ("h" . 'ignore)
     ("l" . 'ignore)
     ("n" . 'ignore)
     :map nov-button-map
     ("SPC" . 'ignore)
     ("g" . 'ignore)
     ("v" . 'ignore)
     ("[" . 'ignore)
     ("]" . 'ignore)
     ("p" . 'ignore)
     ("k" . 'evil-previous-line)
     ("j" . 'evil-next-line)
     ("h" . 'evil-backward-char)
     ("l" . 'evil-forward-char)
     ("n" . 'ignore))
  :config
    (setq nov-text-width 80))
#+end_src

* Configure =sqlite3=
#+begin_src emacs-lisp :results none
(use-package sqlite3
  :straight t
  :defer t)
#+end_src

* Configure =copilot=

#+begin_src emacs-lisp :results none
(use-package copilot
  :straight (:host github :repo "copilot-emacs/copilot.el" :files ("*.el"))
  :defer t
  :custom
    (copilot-indent-offset-warning-disable t)
    (copilot-max-char -1)
  :init
    (add-hook 'prog-mode-hook 'copilot-mode)
    (add-hook 'conf-mode-hook 'copilot-mode)
  :config
    (define-key copilot-completion-map (kbd "<tab>") 'copilot-accept-completion)
    (define-key copilot-completion-map (kbd "TAB") 'copilot-accept-completion)
    (define-key copilot-completion-map (kbd "M-[") 'copilot-next-completion)
    (define-key copilot-completion-map (kbd "M-]") 'copilot-previous-completion))
#+end_src

#+begin_src emacs-lisp :results none
(use-package copilot-chat
  :straight (:host github :repo "chep/copilot-chat.el" :files ("*.el"))
  :after (request org markdown-mode)
  :bind (:map global-map
            ("C-c C-y" . copilot-chat-yank)
            ("C-c M-y" . copilot-chat-yank-pop)
            ("C-c C-M-y" . (lambda () (interactive) (copilot-chat-yank-pop -1))))

  :config
    (setq copilot-chat-org-prompt
        (with-temp-buffer
          (insert-file-contents "/Users/lukaszkazmierczak/.emacs.d/copilot-prompt.txt")
          (buffer-string))))
#+end_src

* Configure =gptel=

#+begin_src emacs-lisp :results none
(use-package gptel
  :straight t
  :defer t
  :config
    (setq gptel-model "gpt-4-turbo")
    
    (gptel-make-ollama "Ollama" 
      :host "localhost:11434"
      :stream t 
      :models '("llama3.1")))
#+end_src

* Configure =psession=
#+begin_src emacs-lisp :results none
;; (use-package psession
;;   :straight t
;;   :init 
;;   (psession-autosave-mode 1)
;;   (psession-mode 1)
;;   :config
;;   ;; idea: save magit commit history as well
;;   (setq psession-object-to-save-alist '((extended-command-history . "extended-command-history.el")
;;                                         (regexp-search-ring . "regexp-search-ring.el")
;;                                         (search-ring . "search-ring.el")
;;                                         (file-name-history . "file-name-history.el")
;;                                         (kill-ring . "kill-ring.el")
;;                                         (kill-ring-yank-pointer . "kill-ring-yank-pointer.el")
;;                                         (register-alist . "register-alist.el")
;;                                         (psession--save-buffers-alist . "psession-save-buffers-alist.el")
;;                                         (psession--winconf-alist . "psession-winconf-alist.el")))

;;   (defun psession-update-winconf (conf)
;;     (interactive (list (completing-read
;;  			"WinConfig: "
;;  			(sort (mapcar 'car psession--winconf-alist) #'string-lessp))))
;;     (psession-save-winconf conf)))
#+end_src

* Configure =ytdl=

#+begin_src emacs-lisp :results none
;; (use-package ytdl
;;  :straight t
;;   :defer t
;;   :custom
;;     (ytdl-command "yt-dlp")
;;   :commands (ytdl-download ytdl-list))
#+end_src

* Work
#+begin_src emacs-lisp :results none
(defconst +work/monorepo-path "~/work/monorepo")

(defun +work/proto-paths ()
  `(("ai" ,(concat +work/monorepo-path "/ai/ai-protobufs"))
    ("creator" ,(concat +work/monorepo-path "/creator/creator-protobufs"))
    ("inbox" ,(concat +work/monorepo-path "/inbox/inbox-protobufs"))
    ("core" ,(concat +work/monorepo-path "/core/core-protobufs"))
    ("crm" ,(concat +work/monorepo-path "/crm/crm-protobufs"))
    ("chat" ,(concat +work/monorepo-path "/chat/chat-protobufs"))))

(defun +work/goto-proto ()
  (interactive)
  (let* ((project-name (projectile-project-name))
         (name-chunks (split-string project-name "-"))
         (module (car name-chunks))
         (is-plugin (equal (cadr name-chunks) "plugin"))
         (proto-name (if is-plugin
           (concat "plugins/" (string-join (cddr name-chunks) "-"))
           (string-join (cdr name-chunks) "_")))
         (proto-root (nth 1 (assoc module (+work/proto-paths)))))

    (find-file-other-window (concat proto-root "/" proto-name))))

(defun +work/consult-monorepo ()
  (interactive)
  (consult-ripgrep +work/monorepo-path ""))

(defvar +work/consult-monorepo-last-glob nil)

(defun +work/consult-monorepo-glob ()
  (interactive)
  (let* ((glob (read-string "glob: " (or +work/consult-monorepo-last-glob
                                          (concat "*." (file-name-extension (buffer-name))))))
         (consult-ripgrep-args
          (concat
           "rg "
           "--line-buffered "
           "--color=never "
           "--max-columns=1000 "
           "--path-separator / "
           "--no-heading "
           "--smart-case "
           "--line-number "
           "--glob " "\"" glob "\""
           ". ")))

    (setq +work/consult-monorepo-last-glob glob)

    (consult-ripgrep +work/monorepo-path "")))

(defun +work/consult-find-file-monorepo ()
  (interactive)
  (consult-find +work/monorepo-path))
#+end_src

#+begin_src emacs-lisp :results none
(defvar remote-host
  "ubuntu@34.245.164.252")

(defun +work/run-nlp ()
  (interactive)
  (async-shell-command (s-concat "ssh -i ~/.ssh/NLP.pem ubuntu@34.245.164.252 'tmux send-keys -t 0 \"clear; python " (buffer-name) "\" ENTER'")))

(defun +work/sync-nlp ()
  (interactive)

  (let* ((file-path (s-chop-prefix "/home/porcupine/work/" buffer-file-name)))
    (async-shell-command (s-concat "rsync " buffer-file-name " " remote-host ":/home/ubuntu/" file-path))))

(defun +work/setup-nlp-file-save-hook ()
  (interactive)

  (add-hook 'after-save-hook '+work/sync-nlp 0 t))

(defun +work/setup-nlp-project-save-hook ()
  (interactive)

  (dolist (file (projectile-current-project-files)) 
    (with-current-buffer
      (or (get-file-buffer (concat (projectile-project-root) file))
          (find-file-noselect (concat (projectile-project-root) file)))

      (+work/setup-nlp-file-save-hook))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +scala/test ()
  (interactive)

  (let* ((default-directory (projectile-project-root))
	 ;; (test-file (buffer-name (consult-find (projectile-project-root) "Test\\.scala #")))
       (test-file (-last-item (s-split  "/" ( buffer-file-name))))
	 (file-pattern (concat "\"*" (string-remove-suffix ".scala" test-file) "\""))
  	 (project (s-trim (shell-command-to-string "bloop projects | head -n1"))))

    (+projectile/compile (concat "bloop " "test " project " -o " file-pattern))))
#+end_src

#+begin_src emacs-lisp :results none
(defun +zowie/to-jira-org-link ()
  (interactive)
  (let ((w (current-word)))
    (if (not (null (string-match-p "-" w)))
      (progn 
        (search-backward " ")
        (forward-char 1)
        (delete-char (length w))
        (insert (concat "[[" "https://chatbotize.atlassian.net/browse/" w "][" w "]]"))))))
#+end_src

** Version update
#+begin_src emacs-lisp :results none
(use-package version-update
  :load-path "~/.emacs.d/packages/work/version-update"
  :defer t
  :commands (+work/sync-env +work/update-versions +work/apply-changes))
#+end_src

* School
#+begin_src emacs-lisp :results none
(defun school/next-class ()
  (interactive)

  (let* ((class-type (completing-read "Type: " '("Ćwiczenia" "Wykłady" "Laboratoria")))
         (subject (car (s-split " - " (+org/property-value "TITLE"))))
         (date (pcase (s-split "-" (org-read-date))
                 (`(,year ,month ,day . nil) (s-join "." `(,day ,month ,year)))
                 (_ (error "Could not parse date."))))
         (header class-type)
         (count (-reduce '+ (org-element-map (org-element-parse-buffer) 'headline
                              (lambda (h)
                                (if (equal header (org-element-property :raw-value
                                                                        (org-element-property :parent h)))
                                    1 0)))))
         (ctype-str (pcase class-type
		      ("Ćwiczenia" " - ćwiczenia ")
		      ("Wykłady" " - wykład ")
		      ("Laboratoria" " - labolatoria ")))
         (title (concat subject ctype-str (number-to-string (+ 1 count)) " (" date ")")))

    (pcase 
        (car 
         (remove nil
                 (org-map-entries (lambda ()
                                    (let ((elem (org-element-at-point)))
                                      (if (equal header (s-trim (org-element-property :raw-value elem)))
                                          (progn
                                            (org-insert-heading-respect-content)
                                            (org-do-demote)
                                            (let ((beg (point)))
                                              (insert title)
                                              `(,beg ,(point))))))))))
      (`(,beg ,end . nil)
       (set-mark beg)
       (goto-char end)
       (activate-mark)
       (org-roam-node-insert))
      (_ (error "Couldn't mark region.")))))
#+end_src

* My packages
** RSVP
#+begin_src emacs-lisp :results none
(use-package prsvp
  :load-path "~/.emacs.d/packages/prsvp/"
  :defer t
  :commands rsvp/run)
#+end_src

** Pscreenshot
#+begin_src emacs-lisp :results none
(use-package pscreenshot
  :load-path "~/.emacs.d/packages/pscreenshot/"
  :defer t
  :commands (pscreenshot/org-screenshot-take +ocr/screenshot))
#+end_src

** Flash
#+begin_src emacs-lisp :results none
(use-package flash
  :load-path "~/.emacs.d/packages/flash/"
  :commands (flash-create-note flash-select-note flash-mode))
#+end_src

** Focus
#+begin_src emacs-lisp :results none
(use-package pfocus
  :load-path "~/.emacs.d/packages/pfocus/"
  :defer t
  :commands p/focus-mode)
#+end_src

** GPT
#+begin_src emacs-lisp :results none
(use-package gpt
  :load-path "~/.emacs.d/packages/gpt/"
  :defer t
  :commands (gpt-init gpt-mode))
#+end_src

** Memo
#+begin_src emacs-lisp :results none
(use-package memo
  :load-path "~/.emacs.d/packages/memo/"
  :defer t
  :commands (memo/create-flashcard))
#+end_src

** Read Me
#+begin_src emacs-lisp :results none
(use-package read-me
  :load-path "~/.emacs.d/packages/read-me/"
  :defer t
  :commands (read-me read-me-generate read-me-read))
#+end_src

** Pjira
#+begin_src emacs-lisp :results none
(use-package pjira
  :load-path "~/.emacs.d/packages/pjira/"
  :defer t
  :commands pjira-current-sprint)
#+end_src

** Winman
#+begin_src emacs-lisp :results none
(use-package winman
  :load-path "~/.emacs.d/packages/winman/"
  :defer t
  :commands (winman-save winman-switch winman-restore winman-delete))
#+end_src
